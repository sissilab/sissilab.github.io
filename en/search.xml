<?xml version="1.0" encoding="utf-8"?>
<search>
    
    
    
    <entry>
        <title>1.1. Singleton Pattern</title>
        <link href="/en/design-pattern/singleton-pattern/"/>
        <url>/en/design-pattern/singleton-pattern/</url>
        
        <content type="html"><![CDATA[<h1 id="0-Overview"><a href="#0-Overview" class="headerlink" title="0. Overview"></a>0. Overview</h1><p><strong>Singleton</strong>¬†is a Creational Design Pattern that ensures a class has <u>only one instance</u>, and provides <u>a global access point</u> to this¬†singleton instance.</p><p>Wikipedia says:</p><blockquote><p>In software engineering, the singleton pattern is a software design pattern that restricts the instantiation of a class to a singular instance. This pattern is useful when exactly one object is needed to coordinate actions across a system.</p></blockquote><p><strong>Key Characteristics</strong>:</p><ul><li><strong>Single Instance</strong>:  a class has only one instance.</li><li><strong>Global Access Point</strong>: provides a global access point to that instance.</li></ul><p><strong>Basic Structure</strong>:</p><ul><li><strong>Private Constructor</strong>: the constructor is made private so that the class cannot be instantiated from outside the class.</li><li><strong>Private Static Field</strong>: a private static field <code>instance</code> holds the single instance of the class and should be created inside the class.</li><li><strong>Public Static Method</strong>: a public static method <code>getInstance()</code>, commonly used as a global access point, is declared to return the singleton instance of the class.</li></ul><img class="kroki" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyMzVweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjIwNnB4O2hlaWdodDoyMzVweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyMDYgMjM1IiB3aWR0aD0iMjA2cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tY2xhc3MgU2luZ2xldG9uLS0+PGcgaWQ9ImVsZW1fU2luZ2xldG9uIj48cmVjdCBjb2RlTGluZT0iMyIgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI5Ni44OTA2IiBpZD0iU2luZ2xldG9uIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxOTIiIHg9IjciIHk9IjEzMiIvPjxlbGxpcHNlIGN4PSI2Ni4yNSIgY3k9IjE0OCIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik02OS4yMTg4LDE1My42NDA2IFE2OC42NDA2LDE1My45Mzc1IDY4LDE1NC4wNzgxIFE2Ny4zNTk0LDE1NC4yMzQ0IDY2LjY1NjMsMTU0LjIzNDQgUTY0LjE1NjMsMTU0LjIzNDQgNjIuODI4MSwxNTIuNTkzOCBRNjEuNTE1NiwxNTAuOTM3NSA2MS41MTU2LDE0Ny44MTI1IFE2MS41MTU2LDE0NC42ODc1IDYyLjgyODEsMTQzLjAzMTMgUTY0LjE1NjMsMTQxLjM3NSA2Ni42NTYzLDE0MS4zNzUgUTY3LjM1OTQsMTQxLjM3NSA2OCwxNDEuNTMxMyBRNjguNjU2MywxNDEuNjg3NSA2OS4yMTg4LDE0MS45ODQ0IEw2OS4yMTg4LDE0NC43MDMxIFE2OC41OTM4LDE0NC4xMjUgNjgsMTQzLjg1OTQgUTY3LjQwNjMsMTQzLjU3ODEgNjYuNzgxMywxNDMuNTc4MSBRNjUuNDM3NSwxNDMuNTc4MSA2NC43NSwxNDQuNjU2MyBRNjQuMDYyNSwxNDUuNzE4OCA2NC4wNjI1LDE0Ny44MTI1IFE2NC4wNjI1LDE0OS45MDYzIDY0Ljc1LDE1MC45ODQ0IFE2NS40Mzc1LDE1Mi4wNDY5IDY2Ljc4MTMsMTUyLjA0NjkgUTY3LjQwNjMsMTUyLjA0NjkgNjgsMTUxLjc4MTMgUTY4LjU5MzgsMTUxLjUgNjkuMjE4OCwxNTAuOTIxOSBMNjkuMjE4OCwxNTMuNjQwNiBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1IiB4PSI4Ni43NSIgeT0iMTUyLjg0NjciPlNpbmdsZXRvbjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMTk4IiB5MT0iMTY0IiB5Mj0iMTY0Ii8+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSI2IiB4PSIxNSIgeT0iMTc0LjY0ODQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0LWRlY29yYXRpb249InVuZGVybGluZSIgdGV4dExlbmd0aD0iMTMzIiB4PSIyNyIgeT0iMTgwLjk5NTEiPmluc3RhbmNlOiBTaW5nbGV0b248L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iOCIgeDI9IjE5OCIgeTE9IjE4OC4yOTY5IiB5Mj0iMTg4LjI5NjkiLz48cmVjdCBmaWxsPSIjRjI0RDVDIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjYiIHg9IjE1IiB5PSIxOTguOTQ1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1IiB4PSIyNyIgeT0iMjA1LjI5MiI+U2luZ2xldG9uKCk8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMjE4LjI0MjIiIGZpbGw9IiM4NEJFODQiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDM4MDQ4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dC1kZWNvcmF0aW9uPSJ1bmRlcmxpbmUiIHRleHRMZW5ndGg9IjE2NiIgeD0iMjciIHk9IjIyMS41ODg5Ij5nZXRJbnN0YW5jZSgpOiBTaW5nbGV0b248L3RleHQ+PC9nPjwhLS1jbGFzcyBTaW5nbGV0b25NYWluLS0+PGcgaWQ9ImVsZW1fU2luZ2xldG9uTWFpbiI+PHJlY3QgY29kZUxpbmU9IjkiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNDgiIGlkPSJTaW5nbGV0b25NYWluIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjkiIHg9IjM4LjUiIHk9IjciLz48ZWxsaXBzZSBjeD0iNTMuNSIgY3k9IjIzIiBmaWxsPSIjQUREMUIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBhdGggZD0iTTU2LjQ2ODgsMjguNjQwNiBRNTUuODkwNiwyOC45Mzc1IDU1LjI1LDI5LjA3ODEgUTU0LjYwOTQsMjkuMjM0NCA1My45MDYzLDI5LjIzNDQgUTUxLjQwNjMsMjkuMjM0NCA1MC4wNzgxLDI3LjU5MzggUTQ4Ljc2NTYsMjUuOTM3NSA0OC43NjU2LDIyLjgxMjUgUTQ4Ljc2NTYsMTkuNjg3NSA1MC4wNzgxLDE4LjAzMTMgUTUxLjQwNjMsMTYuMzc1IDUzLjkwNjMsMTYuMzc1IFE1NC42MDk0LDE2LjM3NSA1NS4yNSwxNi41MzEzIFE1NS45MDYzLDE2LjY4NzUgNTYuNDY4OCwxNi45ODQ0IEw1Ni40Njg4LDE5LjcwMzEgUTU1Ljg0MzgsMTkuMTI1IDU1LjI1LDE4Ljg1OTQgUTU0LjY1NjMsMTguNTc4MSA1NC4wMzEzLDE4LjU3ODEgUTUyLjY4NzUsMTguNTc4MSA1MiwxOS42NTYzIFE1MS4zMTI1LDIwLjcxODggNTEuMzEyNSwyMi44MTI1IFE1MS4zMTI1LDI0LjkwNjMgNTIsMjUuOTg0NCBRNTIuNjg3NSwyNy4wNDY5IDU0LjAzMTMsMjcuMDQ2OSBRNTQuNjU2MywyNy4wNDY5IDU1LjI1LDI2Ljc4MTMgUTU1Ljg0MzgsMjYuNSA1Ni40Njg4LDI1LjkyMTkgTDU2LjQ2ODgsMjguNjQwNiBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3IiB4PSI2Ny41IiB5PSIyNy44NDY3Ij5TaW5nbGV0b25NYWluPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjM5LjUiIHgyPSIxNjYuNSIgeTE9IjM5IiB5Mj0iMzkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIzOS41IiB4Mj0iMTY2LjUiIHkxPSI0NyIgeTI9IjQ3Ii8+PC9nPjwhLS1saW5rIFNpbmdsZXRvbk1haW4gdG8gU2luZ2xldG9uLS0+PGcgaWQ9ImxpbmtfU2luZ2xldG9uTWFpbl9TaW5nbGV0b24iPjxwYXRoIGNvZGVMaW5lPSIxMiIgZD0iTTEwMyw1NS4zNiBDMTAzLDc1LjgzIDEwMywxMDAuMiAxMDMsMTI1Ljc4ICIgZmlsbD0ibm9uZSIgaWQ9IlNpbmdsZXRvbk1haW4tdG8tU2luZ2xldG9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMDMsMTMxLjc4LDEwNywxMjIuNzgsMTAzLDEyNi43OCw5OSwxMjIuNzgsMTAzLDEzMS43OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjMiIHg9IjEwNCIgeT0iOTguMDY2OSI+dXNlPC90ZXh0PjwvZz48IS0tU1JDPVtLeXllQUlhZWpqQk5CeVg5cDJpZnBTdEhJeXhGcktfRUlJbWtyYXQ5SjRtbElpcGJ1VzlwNU84cHl6OXBLYWxveW5JZ2tOR0xnZWpCNGFpb2FzaUxDbEUwaEJwYUwyazQwZzBxZEFzWG9RTURLOW9VTWs4OUxRLVhZUW9aNWlDTXR5SENhNHIwMkxHWEZKcXg5QVRPQVBHTWZ0ODEwMDAwXS0tPjwvZz48L3N2Zz4='><p><strong>Pros</strong>:</p><ul><li>Has only one single instance.</li><li>Provides a single, globally accessible point to the instance.</li><li>Useful for managing shared resources.</li><li>Prevents frequent creation and destruction of instances, thereby reducing memory overhead.</li><li>Ensures consistency by using a single instance.</li><li>The instance can be created only when it‚Äôs first accessed based on Lazy Initialization.</li></ul><p><strong>Cons</strong>:</p><ul><li>Inflexibility: it can make the code less flexible, as it ties the code to a specific instance.</li><li>Typically marked as <code>final</code> or designed in such a way that they cannot be subclassed.</li><li>Not suitable for mutable objects. If objects of the same type need to change in different use case scenarios, it can easily lead to data errors.</li><li>Violates the <u>Single Responsibility Principle</u>, if the design of the functionality is not reasonable.</li><li>Makes unit testing challenging.</li></ul><p><strong>Comparison of several implementations of Singleton Pattern</strong>:</p><table><thead><tr><th>Type</th><th>Thread Safety</th><th>Loading Type</th><th>Recommendable</th><th>Reflection Attack</th><th>Serialization Attack</th><th>Perfect  Version</th></tr></thead><tbody><tr><td><a href="#1-1-Lazy-Singleton-Thread-Unsafe">1.1. Lazy Singleton - Thread Unsafe</a></td><td>√ó</td><td>Lazy</td><td>‚ùå</td><td>-</td><td>-</td><td>-</td></tr><tr><td><a href="#1-2-Lazy-Singleton-synchronized">1.2. Lazy Singleton - synchronized</a></td><td>‚àö (synchronized static method)</td><td>Lazy</td><td>‚ùå</td><td>-</td><td>-</td><td>-</td></tr><tr><td><a href="#1-3-Lazy-Singleton-Delay-Lock">1.3. Lazy Singleton - Delay Lock</a></td><td>√ó</td><td>Lazy</td><td>‚ùå</td><td>-</td><td>-</td><td>-</td></tr><tr><td><a href="#1-4-Lazy-Singleton-Double-checked-Locking-Without-volatile">1.4. Lazy Singleton - Double-checked Locking Without volatile</a></td><td>√ó</td><td>Lazy</td><td>‚ùå</td><td>-</td><td>-</td><td>-</td></tr><tr><td><a href="#1-5-Lazy-Singleton-Double-checked-Locking-DCL">1.5. Lazy Singleton - Double-checked Locking (DCL)</a></td><td>‚àö (volatile instance + DCL)</td><td>Lazy (DCL)</td><td>üëç</td><td>√ó (<a href="#1-5-1-Reflection-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton">1.5.1. Reflection Attack on Lazy Singleton - Double-checked Locking Singleton</a>)</td><td>‚àö (<a href="#1-5-2-Serialization-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton">1.5.2. Serialization Attack on Lazy Singleton - Double-checked Locking Singleton</a>)</td><td><a href="#1-5-3-Perfect-Version-of-Lazy-Singleton-Double-checked-Locking-Singleton">1.5.3. Perfect Version of Lazy Singleton - Double-checked Locking Singleton</a></td></tr><tr><td><a href="#2-1-Eager-Singleton-static-constant">2.1. Eager Singleton - static constant</a></td><td>‚àö (class loading mechanism)</td><td>Eager (when class is loaded)</td><td>üëç</td><td>‚àö (<a href="#2-1-1-Reflection-Attack-on-Eager-Singleton-static-constant">2.1.1. Reflection Attack on Eager Singleton - static constant</a>)</td><td>‚àö (<a href="#2-1-2-Serialization-Attack-on-Eager-Singleton-static-constant">2.1.2. Serialization Attack on Eager Singleton - static constant</a>)</td><td><a href="#2-1-3-Perfect-Version-of-Eager-Singleton-static-constant">2.1.3. Perfect Version of Eager Singleton - static constant</a></td></tr><tr><td><a href="#2-2-Eager-Singleton-static-block">2.2. Eager Singleton - static block</a></td><td>‚àö (class loading mechanism)</td><td>Eager (when class is loaded)</td><td>üëç</td><td>‚àö (<a href="#2-2-1-Reflection-Attack-on-Eager-Singleton-static-block">2.2.1. Reflection Attack on Eager Singleton - static block</a>)</td><td>‚àö (<a href="#2-2-2-Serialization-Attack-on-Eager-Singleton-static-block">2.2.2. Serialization Attack on Eager Singleton - static block</a>)</td><td><a href="#2-2-3-Perfect-Version-of-Eager-Singleton-static-block">2.2.3. Perfect Version of Eager Singleton - static block</a></td></tr><tr><td><a href="#3-Static-Inner-Class-Singleton">3. Static Inner Class Singleton</a></td><td>‚àö (class loading mechanism)</td><td>Lazy (static inner class)</td><td>üëç</td><td>‚àö (<a href="#3-1-Reflection-Attack-on-Static-Inner-Class-Singleton">3.1. Reflection Attack on Static Inner Class Singleton</a>)</td><td>‚àö (<a href="#3-2-Serialization-Attack-on-Static-Inner-Class-Singleton">3.2. Serialization Attack on Static Inner Class Singleton</a>)</td><td><a href="#3-3-Perfect-Version-of-Static-Inner-Class-Singleton">3.3. Perfect Version of Static Inner Class Singleton</a></td></tr><tr><td><a href="#4-Enum-Singleton">4. Enum Singleton</a></td><td>‚àö (inherently safe, class loading mechanism)</td><td>Eager (when the enum class is loaded)</td><td>üëç</td><td>‚àö (<a href="#4-1-Reflection-Attack-on-Enum-Singleton">4.1. Reflection Attack on Enum Singleton</a>)</td><td>‚àö (<a href="#4-2-Serialization-Attack-on-Enum-Singleton">4.2. Serialization Attack on Enum Singleton</a>)</td><td><a href="#4-3-Perfect-Version-of-Enum-Singleton">4.3. Perfect Version of Enum Singleton</a></td></tr></tbody></table><h1 id="1-Lazy-Singleton"><a href="#1-Lazy-Singleton" class="headerlink" title="1. Lazy Singleton"></a>1. Lazy Singleton</h1><p>Lazy initialization means that the instance can be created only when it is first accessed or the static method is first invoked.</p><h2 id="1-1-Lazy-Singleton-Thread-Unsafe"><a href="#1-1-Lazy-Singleton-Thread-Unsafe" class="headerlink" title="1.1. Lazy Singleton - Thread Unsafe"></a>1.1. Lazy Singleton - Thread Unsafe</h2><p>It works fine in a single-threaded environment but may break the singleton pattern in a multi-threaded environment,  resulting in different instances.  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonThreadUnsafe</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingletonThreadUnsafe instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonThreadUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonThreadUnsafe <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">                // Simulate the scenario where multiple threads do not always get the same instance of a singleton,</span></span><br><span class="line"><span class="comment">                // increasing the probability of reproducing the issue.</span></span><br><span class="line"><span class="comment">                TimeUnit.MILLISECONDS.sleep(200);</span></span><br><span class="line"><span class="comment">            &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">                e.printStackTrace();</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">LazySingletonThreadUnsafe</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Testing CodesÔºö</strong></p><ul><li><p>Single-threaded Environment:  can get the same instance.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLazySingletonThreadUnsafeSingleThread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LazySingletonThreadUnsafe</span> <span class="variable">instance1</span> <span class="operator">=</span> LazySingletonThreadUnsafe.getInstance();</span><br><span class="line">    <span class="type">LazySingletonThreadUnsafe</span> <span class="variable">instance2</span> <span class="operator">=</span> LazySingletonThreadUnsafe.getInstance();</span><br><span class="line">    System.out.println(<span class="string">&quot;instance1: &quot;</span> + instance1);</span><br><span class="line">    System.out.println(<span class="string">&quot;instance2: &quot;</span> + instance2);</span><br><span class="line">    <span class="comment">// `instance1` and `instance2` are the same instance.</span></span><br><span class="line">    Assertions.assertSame(instance1, instance2); <span class="comment">// ‚àö</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Multi-threaded Environment: may get different instances.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLazySingletonThreadUnsafeMultiThread</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_COUNT);</span><br><span class="line"></span><br><span class="line">    Callable&lt;LazySingletonThreadUnsafe&gt; callableTask = () -&gt; LazySingletonThreadUnsafe.getInstance();</span><br><span class="line">    Future&lt;LazySingletonThreadUnsafe&gt;[] futures = <span class="keyword">new</span> <span class="title class_">Future</span>[THREAD_COUNT];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">        futures[i] = executorService.submit(callableTask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">LazySingletonThreadUnsafe</span> <span class="variable">firstInstance</span> <span class="operator">=</span> futures[<span class="number">0</span>].get();</span><br><span class="line">    <span class="keyword">for</span> (Future&lt;LazySingletonThreadUnsafe&gt; future : futures) &#123;</span><br><span class="line">        <span class="type">LazySingletonThreadUnsafe</span> <span class="variable">instance</span> <span class="operator">=</span> future.get();</span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        <span class="comment">// It may break the singleton pattern in a multi-threaded environment, resulting in different instances.</span></span><br><span class="line">        <span class="comment">// If the issue cannot be reproduced, try running the test method multiple times or uncommenting the code in LazySingletonThreadUnsafe.getInstance().</span></span><br><span class="line">        Assertions.assertSame(firstInstance, instance); <span class="comment">// √ó</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="1-2-Lazy-Singleton-synchronized"><a href="#1-2-Lazy-Singleton-synchronized" class="headerlink" title="1.2. Lazy Singleton - synchronized"></a>1.2. Lazy Singleton - synchronized</h2><p><a href="#1-1-Lazy-Singleton-Thread-Unsafe">1.1. Lazy Singleton - Thread Unsafe</a> does not support multi-threading situations. We can simply and crudely add a lock with¬†<code>synchronized</code>¬†on the¬†<code>getInstance()</code>¬†method. While this approach can solve the thread safety issue, it is inefficient because it locks the class object (class-level lock, not object-level lock ) by locking the static method. This means that every time multiple threads try to access the singleton instance using the¬†<code>getInstance()</code>¬†method, it will be locked and only one thread can get access, greatly impacting performance. In fact, this method only needs to execute once for creating the instance of the class, and afterwards, all subsequent requests could directly return this instantiated object.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonSynchronized</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingletonSynchronized instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonSynchronized</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// synchronized static method: the class-level lock ensures that only one thread can execute the static synchronized method at a time.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> LazySingletonSynchronized <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">                // Simulate the scenario where multiple threads do not always get the same instance of a singleton,</span></span><br><span class="line"><span class="comment">                // increasing the probability of reproducing the issue.</span></span><br><span class="line"><span class="comment">                TimeUnit.MILLISECONDS.sleep(200);</span></span><br><span class="line"><span class="comment">            &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">                e.printStackTrace();</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">LazySingletonSynchronized</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-3-Lazy-Singleton-Delay-Lock"><a href="#1-3-Lazy-Singleton-Delay-Lock" class="headerlink" title="1.3. Lazy Singleton - Delay Lock"></a>1.3. Lazy Singleton - Delay Lock</h2><p>Based on <a href="#1-2-Lazy-Singleton-synchronized">1.2. Lazy Singleton - synchronized</a>, we can consider locking the instantiating process only when the instance returns at the first time. The instance is instantiated within the critical section, in order to ensure thread safety in a multi-threaded environment. Then, all subsequent operations will directly return the instance without entering the critical section, in order to improve multithreading performance.</p><p>BUT, there will still be thread safety issues in a multi-threaded environment.  For example, in the following scenario, threads T1 and T2 may create two different instances.</p><ol><li>T1: just enters the critical section and hasn‚Äôt instantiated yet: <code>instance=null</code>, T1 is holding the class-level lock</li><li>T2: enters the if code block, as the <code>instance</code> field hasn‚Äôt finished instantiation in T1 (<code>instance</code> is still null): <code>instance=null</code>, T1 is holding the class-level lock, T2 will be blocked before the critical section</li><li>T1: finishes instantiation and exits the critical section: <code>instance=LazySingletonDelayLock@4a87761d</code> (<code>instance!=null</code>), T1 released the lock, T2 has a chance to acquire the lock</li><li>T2: enters the critical section and executes instantiation again: <code>instance=LazySingletonDelayLock@2db7a79b</code> (Now it returns 2 different instances and breaks the singleton pattern!)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonDelayLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingletonDelayLock instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDelayLock</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delay lock in the if code block when `instance` is null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDelayLock <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="comment">// T2: may still enter if code block here, as the `instance` field hasn&#x27;t finished instantiation in T1 (`instance` is still null)</span></span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDelayLock.class) &#123; <span class="comment">// class-level lock</span></span><br><span class="line">                <span class="comment">// T1: just enters the critical section and hasn&#x27;t instantiated yet</span></span><br><span class="line">                instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDelayLock</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-Lazy-Singleton-Double-checked-Locking-Without-volatile"><a href="#1-4-Lazy-Singleton-Double-checked-Locking-Without-volatile" class="headerlink" title="1.4. Lazy Singleton - Double-checked Locking Without volatile"></a>1.4. Lazy Singleton - Double-checked Locking Without volatile</h2><p>To improve the issue of <a href="#1-3-Lazy-Singleton-Delay-Lock">1.3. Lazy Singleton - Delay Lock</a> mentioned above, we further add a check within the synchronized block to verify whether the¬†<code>instance</code>¬†is null. If it is null, then proceed with instantiation. This helps prevent multiple instantiations caused by multi-threading scenarios.</p><p>However, due to the¬†<code>instance</code>¬†field not being marked as¬†<code>volatile</code>, errors may still occur due to <u>instruction reordering</u>.</p><p>When creating a new object (such as¬†<code>instance = new LazySingletonNoVolatileDoubleCheck()</code>), there are essentially three main steps involved internally: <code>1. space allocation</code> ‚Üí <code>2. initialization</code> ‚Üí <code>3. reference assignment</code>.</p><p>The JVM allows for reordering of instructions for performance reasons, while these three steps may be reordered, such as <code>1. space allocation</code>  ‚Üí <code>3. reference assignment</code> ‚Üí <code>2. initialization</code>, ¬†it can potentially lead to thread safety issues:</p><ol><li>T1: enters the critical section and ready to new</li><li>T1: space allocation</li><li>T1: reference assignment (Since initialization is not yet complete, although¬†<code>instance</code>¬†now points to the newly allocated heap space, the object is only half-initialized.)</li><li>T2: In the first¬†<code>if</code>¬†check, when¬†<code>instance</code>¬†is found to be non-null (T1 has not finished full initialization yet), returning the partially initialized object directly leads to program errors.</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonNoVolatileDoubleCheck</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingletonNoVolatileDoubleCheck instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonNoVolatileDoubleCheck</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add double-checked locking without volatile `instance`</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonNoVolatileDoubleCheck <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123; <span class="comment">// T2: directly returns the `instance`, but not fully initialized, leading to a partially constructed or uninitialized instance being returned</span></span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonNoVolatileDoubleCheck.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonNoVolatileDoubleCheck</span>();</span><br><span class="line">                    <span class="comment">// bytecode: 1. space allocation -&gt; 2. initialization -&gt; 3. reference assignment</span></span><br><span class="line">                    <span class="comment">// may reorder instructions as follows:</span></span><br><span class="line">                    <span class="comment">// 1. space allocation</span></span><br><span class="line">                    <span class="comment">// 3. reference assignment // T1: the `instance` is assigned the reference, but not fully initialized</span></span><br><span class="line">                    <span class="comment">// 2. initialization</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We already find out that there are so many steps inside creating a new object. So, Let‚Äôs delve into understanding the creation of a new object from the perspective of Java bytecode. Let‚Äôs start by writing a simple test code for creating an object as shown below:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">NewTest</span> <span class="variable">newTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewTest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We can compile <code>NewTest.java</code> to get <code>NewTest.class</code> via <code>javac -g NewTest.java</code>. Then, we can execute <code>javap -v -p NewTest.class</code> to get the bytecode information about the fields, constructors, and methods of a class file.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Classfile /DesignPattern-Lab/src/main/java/com/sissilab/dp/ox1_creational/ox11_singleton/NewTest.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">25</span>/<span class="number">07</span>/<span class="number">2024</span>; size <span class="number">487</span> bytes</span><br><span class="line">  MD5 checksum e132b23dc7ec6394be9137ad5aa7c33a</span><br><span class="line">  Compiled from <span class="string">&quot;NewTest.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">com</span>.sissilab.dp.ox1_creational.ox11_singleton.NewTest</span><br><span class="line">  minor version: <span class="number">0</span></span><br><span class="line">  major version: <span class="number">52</span> <span class="comment">// Java major version, 52 indicates Java classes compiled with JDK 1.8</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER <span class="comment">// class access modifiers: the class is public</span></span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">4.</span>#<span class="number">19</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Class              #<span class="number">20</span>            <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/NewTest</span></span><br><span class="line">   #<span class="number">3</span> = Methodref          #<span class="number">2.</span>#<span class="number">19</span>         <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/NewTest.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">4</span> = Class              #<span class="number">21</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">5</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">6</span> = Utf8               ()V</span><br><span class="line">   #<span class="number">7</span> = Utf8               Code</span><br><span class="line">   #<span class="number">8</span> = Utf8               LineNumberTable</span><br><span class="line">   #<span class="number">9</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">10</span> = Utf8               <span class="built_in">this</span></span><br><span class="line">  #<span class="number">11</span> = Utf8               Lcom/sissilab/dp/ox1_creational/ox11_singleton/NewTest;</span><br><span class="line">  #<span class="number">12</span> = Utf8               main</span><br><span class="line">  #<span class="number">13</span> = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #<span class="number">14</span> = Utf8               args</span><br><span class="line">  #<span class="number">15</span> = Utf8               [Ljava/lang/String;</span><br><span class="line">  #<span class="number">16</span> = Utf8               newTest</span><br><span class="line">  #<span class="number">17</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">18</span> = Utf8               NewTest.java</span><br><span class="line">  #<span class="number">19</span> = NameAndType        #<span class="number">5</span>:#<span class="number">6</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">20</span> = Utf8               com/sissilab/dp/ox1_creational/ox11_singleton/NewTest</span><br><span class="line">  #<span class="number">21</span> = Utf8               java/lang/Object</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> com.sissilab.dp.ox1_creational.ox11_singleton.NewTest(); <span class="comment">// auto-generated default no-argument constructor</span></span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lcom/sissilab/dp/ox1_creational/ox11_singleton/NewTest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>; <span class="comment">// main method</span></span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">2</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="comment">// new: allocates memory for an object of the class referenced by #2 -&gt; adds the reference to the top of the operand stack</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">2</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/NewTest</span></span><br><span class="line">         <span class="comment">// dup: duplicates the top stack value -&gt; adds the duplicated reference to the top of the operand stack (because the subsequent `invokespecial` will consume a reference.)</span></span><br><span class="line">         <span class="number">3</span>: dup</span><br><span class="line">         <span class="comment">// invokespecial: calls the constructor to initialize the newly opened space and consume a reference</span></span><br><span class="line">         <span class="number">4</span>: invokespecial #<span class="number">3</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="comment">// astore_1: pops the top stack value -&gt; assigns the reference to the element at position 1 (`newTest`) in the LocalVariableTable</span></span><br><span class="line">         <span class="number">7</span>: astore_1</span><br><span class="line">         <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable: <span class="comment">// maps the bytecode instructions to the lines in the source file</span></span><br><span class="line">        line <span class="number">8</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">9</span>: <span class="number">8</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">9</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">            <span class="number">8</span>       <span class="number">1</span>     <span class="number">1</span> newTest   Lcom/sissilab/dp/ox1_creational/ox11_singleton/NewTest;</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;NewTest.java&quot;</span></span><br></pre></td></tr></table></figure><p>Although just a few simple lines of source code, the decompiled content is extensive. Focus mainly on the Code section below:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">2</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/NewTest</span></span><br><span class="line"><span class="number">3</span>: dup</span><br><span class="line"><span class="number">4</span>: invokespecial #<span class="number">3</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="number">7</span>: astore_1</span><br></pre></td></tr></table></figure><p>The process is illustrated below:</p><div class="excalidraw-svg"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1081.6370313640625 772.25" filter="invert(93%) hue-rotate(180deg)" class="excalidraw-svg"><!-- svg-source:excalidraw --><defs><style class="style-fonts"> @font-face { font-family: Virgil; src: url(data:font/woff2;base64,d09GMgABAAAAABiAAAsAAAAAJtwAABgwAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRwRCArDWLIAC1oAATYCJAOBMAQgBYMcByAb6RxRVM8qZF8c8ObQKYfzYhl1y0eMQV7LSUc0Z7N3uUsupuAxxBPEvyQhCSFYMGkJEtxq+o7U5SsKfVEqKnzfpOb8pdNPuuuk1vChPSAob3rArtlt97UkcKzAWjLF+SA7QCTo/4ACgf+b0+/lrbS9unKcwoPgA6ZVOjlzMsCfNptm27eVHduhgu1QYSDw27QD1DfAsvXBlOXQVLP2iL9rg5pCeIzD/fKh/Wb9h1cRqZROLMdHH8zsEEuTJN6uzWIVtSQa99fqQiuUuFJmaW2tg0+xU6RcNovrixdnAhpmQf1AAGAfYQUAkAKVbjjAJxAKryMWIEiMYYA7IJ3GroUZZjPoQA59eNf7j4BoR6AuAODlmi3oHPY2Fk89U0QmxCqHvJYGC5gH8KfAJTxMBX4QDOEQBbFggVTIgTxogW7oGx8HqAr7QhBoSLauFNp+q/Ex99xy3TVXXHLUIT+Mfz8+Mj48vhcQYAiNA0zKA0mBEKFhpRTZbwE9DEAJAxSaMZ8seCVgiYQb5zSnP3CjKCjcU+gp9Z3EKyvIFIsnTcjM+EDrFCcOkIXma2VFBUYnN5lvuspmdpX7i4PMFbZYW/Id+ZvHyLBXDVdO3xHQXjM0MrWKekNDt4Wf6azUExbrNYJQP43wKeQllFy0bZuJyPbz8b3b9ZweMB88gkpFIObiTB4JdqlxDF03qnGggBhMeFKzuXIBgyHFQEoo++9hZEXa4KUgCCQ0HMWbRIp6kOHIR5fXyo6yGem8aKMY50QtE6zUtjt5SKENSuJFwe5+CWNFHLXw/v2/st2cUQFN/8QbL/vqoU4/yqVf7CYnogRb7M/nV4West7eXrxRpkoXHfUIh1vTUKlx+sb/8VNhcN+nCadRyAdmcAmjMXo4HGKeG5YTMbp6miDP5uGlPrW59O3axLaZo9ilwMK9i8LBkfLmp9haTLTPMrHvzmp7ndyY/EjNJTyFjlWY/v+8RhxS0xf1bpcBJ/KGgj+QqFJYsNSgcYzI0OWV6UXQHIyRLsetnShngmHQNQPY7VsuSUc6YHesyc3d6dNTgeJ54x7zqkRhaPeCllNI8ZQehAXMDa9UQLcL+O+cpeZK6uBk4e3VtNRs7r7L1Lwyf9X1q2AN0Yt5KfBQOupTRPx1/4Nh8r1X5chxMFoTonWMasgJTal59M7kaHxR9ifNkspzIdj9GbBop54UvIwnT4Ez8PfRyXiWO/q2vKrJvtytWjeS8t+j8wMzUCa6+IvA6fKxwEOYMKkJ0e06HU+z2YZJ0oWxMgezap2iDGiHoOdxVbAGRvgBO75TN1xd0dN8r7Mvnos2xEHPKGpw56h0QgFaCwhh34IQI5tsp2gZAmX6kF03g0e2hDMFlUfmCnYHq15tJqL5hY3K4lVhkMJlQFdKikvI/YV4mvV7B6kL2CCqC9zHV+9XaKD0YOGazQ3Ti/PuRHC9NhBtWRN6zXB1y9Bb+awYLgKqxlNlM9jPnk4yIaJWXd3KT48rE9WMkiRYbiigFa8BKCV4Bxol7xbK30czTL+eXzxZW6LTuupgIlYZpIr0vAJ0m0Dnpwwu1jGqhXbIKbRt4gQZzyTlaCBWi1Rcvw+xru1aUYKVzvpHosPxVZgwGXSmnZ+E/PRT7LfvyXPJOGciykEAVkFRdsLtmJd8OdNR58600BQ3/qbXqhZjNf4DYe3cRYrT9a02mXQEhGEedJn0dw3yJEcJ6VLGDKln4C2kAceYUDzrYAGllGhPsEadvL2SJdu2PV6SYi6fidrqViayEQ9NJLgLBTrKVA2CgAU7tnguSua6icX+JnZLWvzqtyHrQ8im+mJtMBE+8Z+JO8GxMTWfU2/dB1ilnLEJqOn/KwSUF12SOLPS5EiLB/neY3ofzTvnapPraH2/KhL9xY8idhksPF/WbPZ4eaA9Tj2bh6eTEvCckZETYWuYvDNgkL/cHeZ0G63K2J/XP+pXlkSsD8sFfEsGsx1lFmwDe1dYLfB4Gs+EH3cLhR5pJT0k6dnVkE8fkhtK/HUupeYZSllOvrm5q89n273i4EAAJnDwFfIY7G63oBoeXz6/vvAneYBdyJ9U0+o4Kbu1z+kfM0pGcDEu2NljIGrT6b9jo05Je03Eedrm5LkcV4gqBcp0iDT55+FGzENAao5w39/0W4gKivvR+NdjlFRqO5Vjt7Cg7llqXgwpw16idI32O6di9aEvNne27uG3QZ4rtNJFXQZOYfjyJTttiX98pGtedd9TssJY5aJBVkZCJ0akRdTeEiMG2WkcN5Y5eS5BV6K1IoMT5CSX7s4UbE7j8+cN6maQmgRn1GScJ6QTp5QMgM9THSuOnplP9VXvbRDZZ1rEOu0dhc2DjWQu0Vc3GdxWnpTAD06A0sZWvMdA/5ZKLvqEH764CKEyCxTtcQYzF5pGfav7vv25W8D4ElJjsYMt7VdrItGrlRUnaZc7nGybl2kVE8cXfTVjUNyOD5bpBgJSk5ucqaLVUwZZWeHjm3SdPPDs+EdMW69zkkSjdHyeUqrprXDVcMkrbOyR4dsrDDi9Sr0eb87ENMF08414GstuPJDb00vMMyVJkgd8fbZ8LBxbo+ZJ+uPODeVLyl3U1FPKHGdya3I2q6dl7s2o1bYkm51WzSYPiUNi86dOlpdprcMgSxs3xJMHkAPJIHh1ySlJ+YwPSv0LlS3p+cX/H4oZFBX/k0gRgFa8ZpPTDt4Ph5/61cpTPLg7P7I2s73jTnOgxUp+Wny5EKxmVxMDTC32W86qEVHswgKNn/DMBLsSbIRsuB5DAaS5xb7hdtp7fyv3KzPI/WIGtND4rFp6esAhFRLlEvlLyGAgpFZ7ySTcsFNl6E/VJCFgQA3yJlZFbuEQTdnlqpDpVGwyiG+X/QI4DL6nJ7+NzTJtnP4DdU6qvhNhFTYZhD58ioxE16ss/fX0mJyh5D066kGe3PCUIgVDU7dJB+tipTqp1u16gfaW0nYymZ/hRg3WSoppSb65uXnfy+VGeRLsBd6JIjTjIIDGlhk2VlLkudI8cOdJ53RZ6uJ4Q6NRuM/gotRP88GVct/H7lXRojYIX9r4Aj5XMN/KPAgAXb4eX17/I5731fCrI285K/+tD0VYzM0Q2fGR2+LHU2u/VN8jRTEHm2X7na+/ns70wQ4VNOy5hlpuptTxAQchgODcK86KnXo6D+Puz49wSGdH+NNWOkqQ/9ZMnmPrM7FDHs6oY524uLwDXxdFuHFoS93Lf+z/EG22/DVDDJcPy0DIiJFtL7pEQWNMgk+KUwZ5GQy26ltC1ysfkfdj0kuVpA2vx3uiHsX6qJynHlHHCmA3NMGXzdpoHBx+vjlXFaPXuiwKjxhdFHtPrpoe9EudWWKiRVtimoewvsfnSJONvtExufv7q786OFYg1Lfo7MzjucMEy7r1mWi1bbnaf9fjcYQzg2u1mtjUV0WI4IRWOpNuZMT186+ncdyfNtsMLuUlDFwWHh8do/0Xw78xbfc4FTABg++wWT1RHeZ0OtESQrJYLgF94S8Grw/hf13jUEN8JO+SuQaO+TDODxb227nlbV3ZPl7cZIcr6RtKz9O7gGsurVtQgHNI38T1jLHWsMwkrSRvN2UFwkqLIW8wnDwmC7MZyomM9YKj87qE7sFu1H8cPBIz0dasE+ZOXyxgdpFta78KJEazYbUH4+qJ2Z8Fw6zYz35OuR9MdYlDhWG5+c+yMkkMxSLMrcF8YMZB3ohS6LK5aT+LvoM6n66IHZSVyBPRm0I/bBhHQJ0K/8ZgeRcyXxBXF4nESMgP1Ss6ciOWLVGXi2MsBZ3Kbr/xnDFn1iTKYH927rvz7nKgY5WCoFz/9u44VfvkbVnrTvMF8Br4gtv7JRz6etry6wxVYpoya7Yyz20Bx2LWz8SveF6RDhyg6E9xHohJmeWJTPyC6P/9on3t+vJDhWNVMwaldp/+48b7guXbwOgkTUG9Fb95D2WwSksPSWasboTp1pg1JpZ+9m3kwyDKfXP0+h7lmCo3cMFXGypp3rbUO6apE+M/QYVOpUFThK/oRe89dVHf9vgZ1z2BkZJDaergma+WXdo4M34hVKV5s8Q+zk55/7PFT6TZvRHIhbmvjImxebQGLmcSXp3cS2OL/kZGNOqBQfHAlTvd9FpyxAPvi5/MNHjtpa/scWrNa1w2q0GEpMgLhcmz9Lrw77xCypR/Z+XJY+5T0MWpm6rK9jNcrOq7MmPREQM/IcejZle8nF6x8IJgSrMtPpssvXhy+a4RdFHisyH+/zfGj2lj+V+KFHyEs49KnVXn4RlOkiHmBeWzipVPMsVWXZpi9/GMH6PjqCXX96U6by/mVJaZypdbD/i8HbZJdZKXbaXUWLpYXO5s/WzCJ5cuBtv/nP3oC0HpB7RqMMfnrd9Gm5dENkyCvghL4e+l8yJYNGO2cWUDfe3jsYWOl6YxmP7f0Qfp4tOOtVZnBhc7nZhvMm0f3PPRg6yiZ8SzdRELq0Xd/iEv6BGIvwyJFWU3BGaZgCPMHpFIgtZhSr8Fc3Zv4a1h8x8L0dVQbvQnrhJ5AGjatUpTCZ9B4IE0yOzj8QrXjs4Z/SYk0CHyX/RY4V3D5Mlv17ksvzzyWJiO6XEMaeS4H67RgMYujnR/SP4U3NohiPPSWp8s6kziNJ8I+AxLQcfwKaPY0bOeZoasQ2Un7TQH5Q8ZOa4eW3huC1gbWcgQ+SGpk2r2+NN+mhHH5/xVQQ9Apl6MO/fArKXOE6HyBwPRpz5tZooZpaPtCTUqySyiJsDJ1sNXlkwoCGEVoixsFBdt5D93bmhjcKkkhQcyIs7XQoZBAq+C3abiFllIca1NHVXpLN1+DOFYfrMryuBSJle/DFHHPjk5i7J54XZYitdRWdgefWbUb/8ma9RFET0SqzZgUiCDLEV/LgliiTZwrJv/KXjqN9FNRBU23QxTHZ7PnLE26+OsqSBwrZpG4fXBGDWPC8wOfvCY9xIt2vbUW4es1F/9S7JN2txGn8nxvGur9rTaNGgy/vX9j2ckQdvga8OBReXzdCyifx5WgmyiGs2uKeH709yY5IEVKZ7t/REJ6XMnPdPHNzoaUTuWrtyyrRhSUrklGlsOZKBprR7js1QSXrz763K/JdmyErqOcMzF17bwiRamBY1ZaQGkWeHJQMv4Leta2JvYIkL3QEf8Rc+H8wwmtXw97jRd+R3/iCExzIHSCRHtBMiiZr60j3xvPoKU25SOOo+8sydqespGPdKk1mTOL9j+6Y8ff4vlBkZ456hzvyv5egduw3zD3qVVzt+f3PNxaO/APvX8Hte/M6M0IDM4n85FGsLMIluIx3t5tu94ayRkcZV8A5Yrj+U4kgSB7CoiASewhhnbGTZiBv8NEclgfwR5hqdF0KPs1s4l1itC9we26tplGXX24eJNsOTzzvXJlca1D/RO3p/WXc/Ilfgjf9M3gZXKAQsvgy6oXR59+vZkrWNi+PrwzspX/fxtmG8cWu3EnuVdHmfQzsmr8pe4qAXX0BSHBe+hh1tpYUMFwy00kEV+w3SV/MeR1N0WLGG6PSR48934HzEMchx/pqNlkgLLcs9gmzK65cMlqeF2VJnkZw2mSpClQUdF7/N+aOLCa2OWYLh35AuxKHF4iSMNeAebPp8lLfX5Q3dMUdWUcGwU3/drTPimP1sfdV5uSMXLAjY+j1/bKOxxdhwn4v98WnG+QWQt83z3GohtdCpjdl86W78BY45kaRQjjjCwtexXyF7URZlWSxHei6QM+yrOtFn0+K8fZrmmBMl4ZBPpxa5Xe6apdYClYCH5bq46q8ffEXRizzL//aTtrfhYbGpYUvKhYxztiZu7XpGZUOWWVJzrWoVfKDYH0vLyEyNl4b8qSa0CUUxdZ5EeH5LiwYNBQ/SybyivaMP6z4/+Js/HbZpkL5+Jf/k090kkP8+hzWKoUALbX+f67ItMJ5cbVSgS0qm+LYWS6SpPfn/sMIlKZSSrmCXaNy4q8hO9aE7VFUyqGPFOUlCEatvpjY7/c5yMsbrcyvw09R9Hbdy53NqjJxaL8i8tmRAATySu9ZK13jLnLgbBiHabzqLfTlMMvJw/y69PIkyE1NtlMuF3xsEXShySBWTKhBhuZzIrLlSTMj/WwozLzjuUHpUEJIP93eiXpgcfJBvj4pK3VX0ruKWWG8Slnh+vxPkPNMP6OWoznUlzj64xBXzKX0Dmdt8O/EMoMkcVNa7QOUPsv9/51Ycn13DYV1nSQeGKcDVO44SEabAUIV6MOVOtTjGs2W0w/utdZlBMYgMlIrs6e6qkUoVF7Fmwxq3A30ssyGMxvC9bZGYmLxE4gZN+RraBTdk7QwvyYwS1zG4p5vcpn9po+dOVbqMX0F3c//Q+ck7S2HwpiKEMQViIX51hI3BA5WWTsrqN7xfsmCo1r6D7cxKGM1OCFIHuAz9lfiPlzi3goLoci+f+j32ec8M4JVzLDu7L+8vDQq46STP+Lgr1O+zwps35qjAdVn+2pwJhDIwq35Ax1XRsW1jQtyxmtbvBX0R8pvlSjenr6cWqXkvb2pe1Swm95rfNbAFZjZPmlwc7bBPLIJH5UwCfDGg3uQ8UXJhm4hpuYnXBkLKHxTpJB4oV1Ct18+Qw8SQmB00U1yIrJ8a/ZnQNp++YWHYMST7IhBZ5aeCj3kcFfl8/E0eVOlTxab3Xdy+0jjIKUf5P7iu82d0Hc8abdnwUNAWroLTZxh7BqgyhSYXCUv8dwm4n5LPqMC0Y7V6Gj2kb7erV2JNYKXsARDx9VESWKDi9dZ3xe89k1iJ3Ao/BCRo/8aH8UF0AxUSdkF+THnnTfHWUz9hQ11+/zyMpV5iJH0Auf8lrSKazsKpaqC/x3mVJKmOA25yGOv/av7rfbF6aYF2QcCzMvDOhcarbM0eLhuFf+2NyekDjw331Ab550uRoM4t7cJlneE5woDR61rKTs5W8b3cRRa7eoGU+PCEycehDnR4ayzv2tP+aJihvZoWvolHYPAW9LrZycFnk3paWm3k/CHySmFsYUOWCskoo49DEiJ7sFLd41xMuhsRTNxZsGnJNJigFqFj19xZpY8zHcsLDcFmI7Sm3I9z5xnmGRnfly9yED90nBOTVS3+wrvuYw/172vXVoDeJrnhFh/7tvnGvjiUNHArrClqdZnB4pMSYyy+6ko36RNGrEnU2gSnwR9phY5dFkjWXyHw40vnm2uW5L+4NZ2I0Jju5pC1VdOmhoFUxbRps+Q5luqfkJeppcsp9b/mt+4kxogK2pkpYjVbWSDcGe6H8KvQM097cq7+waTvMLHth5u/l97PMbG9p4m4X7UPqouaJbVg/x9RdOyWJ1ineNXrhTqbOPjkqzdYqn8a6UOx18UsvRE9kAKxz1kWf2UnHafYNXMUrNRZYSaU2BTyJYZFEoSZqcZ/F+w7++7WEi6haKGXmcsjg5yKlduY1rPXDYDZOw9ResSF+z8tfsyTWZ4eVs/tXRRA4yHYqH1b8xrz8Xo+nuNRJPE/ufKx6V9J0bZ+vnVygPODPIwOSZ+lspkkrLf8aNgu+RosEB7WC4W8M7vxHTpZTZWqdB0g9STZfH6avtl+df1dJFRJNdLpO6CSlX9PqlcVYo1EYybhRe0T4jeS0aPMvhoIdFofAgTJ1dm5B+weWYKPZKA891+lwNlqW43LWpdC1VH7ABA83VAJzmQ9br72cww6nO5tWRHR8UiH8Y5k8tsrA4tWQrk3N5ut2+2XN96OV7MkiEW8RSuF4LMjQfvpl3O1qtIyPGzTM0mJnvs3mlNo9lswYJTS/6ACpf7+t3fxcXFbKi3/GYOF/AOo36xtPJdf4ef1/G8Yr3r2m/UWbCgAMwBiJnz5thLpCM14kTvEYHohMAOgpBe7Jt1kDTJQFArQCREgIBmwPaBBvHHYGidhWQNgMYGEu4ASPQY/5gAeWDxzMDhSuHj89Ahh47Pgf7YdCjPu5b0GKngOFxQCGqUCIfhv/uWfARf+BM9wCAlnGF6Dfx59Eh1SsFwLQJZBh/iBF/4IT2lXs7QlcLGL8wqLBB2MBHyubLsSDZOv9gXAXSGA+h1T6QNWADkWGIRpVGGfBaBABG0aCGHBhcxCHPLAFaSCF2CABHuAG0gEoA7XQBtXD4Q0QBFng0KQTZREaJw7SPrwZmkAOmlDUQnDCs5YmDAohA8xgprfGURYTx2VxEKrEPuJ0IRWiCn6beNbwRGiGFugdR61fqwY6QA6+UAF+iaihDVSzcuh1KKSh01FVyIDuLcuZt7C5I0OnR2UVpSHYMz00hNnypebax+BIiANdDpWkHhwQjQAAAAA=); } </style></defs><rect x="0" y="0" width="1081.6370313640625" height="772.25" fill="#ffffff"></rect><g stroke-linecap="round" transform="translate(14.490141898123547 38.5) rotate(0 50 67)"><path d="M0 0 C25.66 0.7, 51.37 1.35, 100 0 M0 0 C24.31 -0.36, 48.98 -0.01, 100 0 M100 0 C100.25 29.92, 99.83 56.31, 100 134 M100 0 C101.85 34.28, 101.22 68.56, 100 134 M100 134 C79.06 133.86, 56.21 136.15, 0 134 M100 134 C65.44 132.33, 31.25 132.83, 0 134 M0 134 C0.3 88.25, -0.78 48.12, 0 0 M0 134 C-1.61 98.19, -2.28 60.29, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round"><g transform="translate(13.490141898123547 83.5) rotate(0 50.5 0.5)"><path d="M-1.04 0.59 C15.95 0.49, 84.78 -0.22, 101.69 -0.11 M0.61 -0.14 C17.53 -0.18, 84.66 0.37, 101.11 0.84" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(14.990141898123547 128) rotate(0 50.5 0.5)"><path d="M0.39 0.38 C17.24 0.29, 84.83 0.36, 101.56 0.38 M-0.87 -0.47 C15.83 -0.48, 84.11 1.26, 100.91 1.59" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(236.74014189812357 76) rotate(0 59 47)"><path d="M0 0 C38.66 0.54, 74.91 -1.33, 118 0 M0 0 C39.08 -1.01, 79 -1.36, 118 0 M118 0 C118.44 24.68, 117.96 48.68, 118 94 M118 0 C117.52 19.38, 118.21 40.02, 118 94 M118 94 C75.19 94.43, 34.15 92.27, 0 94 M118 94 C77.82 94.84, 36.63 93.55, 0 94 M0 94 C-0.41 67.76, 0.15 44.89, 0 0 M0 94 C-1.14 63.88, 0.01 33.28, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(307.74014189812357 77) rotate(0 22.649986267089844 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Heap</text></g><g transform="translate(31.740141898123547 10) rotate(0 28.91998291015625 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Stack</text></g><g stroke-linecap="round" transform="translate(246.74014189812357 131) rotate(0 27.5 15)"><path d="M0 0 C13.07 -0.5, 24.09 -0.47, 55 0 M0 0 C20.86 0, 40.47 -0.2, 55 0 M55 0 C54.71 11.37, 53.62 22.77, 55 30 M55 0 C55.08 7.66, 54.81 15.23, 55 30 M55 30 C33.78 28.33, 16.56 30.71, 0 30 M55 30 C32.6 31.02, 12.05 30.79, 0 30 M0 30 C-1.55 19.6, 1.06 11.72, 0 0 M0 30 C-0.39 19.09, 1.08 8.35, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(425.48199552483726 66.08986759809187) rotate(0 60.999977111816406 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#f08c00" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">0: new #2</text></g><g transform="translate(390.7271973769546 101.93924394222455) rotate(0 244.56980895996094 37.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">The `new` instruction opens a space in the heap </text><text x="0" y="42.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and a (ref) reference returned will be pushed </text><text x="0" y="67.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">onto the top of the stack.</text></g><g transform="translate(49.740141898123575 49) rotate(0 15.269989013671875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ref</text></g><g stroke-linecap="round"><g transform="translate(92.74014189812357 68.11313063217625) rotate(0 82.39279176369308 37.4946599132646)"><path d="M-0.89 0.14 C26.71 12.72, 136.76 63.71, 164.57 76.09 M0.85 -0.83 C28.35 11.39, 136.01 61.83, 163.51 74.55" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(92.74014189812357 68.11313063217625) rotate(0 82.39279176369308 37.4946599132646)"><path d="M138.6 72.39 C144.3 72.68, 151.34 75.49, 163.51 74.55 M138.6 72.39 C145.59 72.46, 151.07 72.86, 163.51 74.55" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(92.74014189812357 68.11313063217625) rotate(0 82.39279176369308 37.4946599132646)"><path d="M145.82 56.88 C150.02 60.52, 155.49 66.71, 163.51 74.55 M145.82 56.88 C150.92 60.89, 154.56 65.24, 163.51 74.55" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(11.115141898123547 221.25) rotate(0 50 67)"><path d="M0 0 C29.44 -0.7, 55.63 -0.91, 100 0 M0 0 C36.16 0.91, 72.68 1.15, 100 0 M100 0 C97.91 46.56, 99.03 90.25, 100 134 M100 0 C100.41 37.51, 99.77 72.39, 100 134 M100 134 C67.63 134.86, 33.94 131.36, 0 134 M100 134 C77.67 134.39, 57.98 134.63, 0 134 M0 134 C2.75 104.98, 2.63 78.39, 0 0 M0 134 C-1.83 83.55, 0.09 33.35, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round"><g transform="translate(10.115141898123547 266.25) rotate(0 50.5 0.5)"><path d="M0.88 -0.71 C17.85 -0.59, 84 -0.18, 100.81 0.16 M-0.12 1.53 C16.77 1.83, 82.84 1.65, 99.77 1.26" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(11.615141898123547 310.75) rotate(0 50.5 0.5)"><path d="M-0.71 -0.19 C16.08 -0.04, 83.15 1.77, 100.16 1.78 M1.11 -1.33 C18.33 -1.6, 85.82 -0.26, 102.43 0.07" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(233.36514189812357 258.75) rotate(0 59 47)"><path d="M0 0 C42.67 1.49, 88.71 -1.62, 118 0 M0 0 C31.27 0.9, 61.87 -0.44, 118 0 M118 0 C116.3 18.86, 118.41 37.34, 118 94 M118 0 C117.98 31.1, 118.45 60.79, 118 94 M118 94 C80.55 91.6, 48.08 93.72, 0 94 M118 94 C92.77 94.22, 65.9 94.37, 0 94 M0 94 C-0.01 59.36, 2.06 21.49, 0 0 M0 94 C0.08 75.51, 0.38 55.61, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(304.36514189812357 259.75) rotate(0 22.649986267089844 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Heap</text></g><g transform="translate(28.365141898123547 192.75) rotate(0 28.91998291015625 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Stack</text></g><g stroke-linecap="round" transform="translate(243.36514189812357 313.75) rotate(0 27.5 15)"><path d="M0 0 C10.84 -0.9, 25.31 -0.94, 55 0 M0 0 C16.97 -0.85, 35.99 -0.29, 55 0 M55 0 C53.47 6.68, 56.7 11.52, 55 30 M55 0 C54.14 6.46, 55.97 12.28, 55 30 M55 30 C43.64 28.78, 31.78 32.41, 0 30 M55 30 C35.4 30.41, 16.62 30.35, 0 30 M0 30 C-0.46 20.24, -0.55 16.21, 0 0 M0 30 C0.03 21.98, 0.66 12.97, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(46.365141898123575 231.75) rotate(0 15.269989013671875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ref</text></g><g stroke-linecap="round"><g transform="translate(89.36514189812357 250.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M-0.45 0.01 C26.88 12.74, 136.69 62.83, 164.32 75.29 M1.52 -1.03 C28.62 11.41, 135.91 60.48, 163.13 73.32" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(89.36514189812357 250.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M138.22 71.2 C146.41 71.22, 155.08 73.57, 163.13 73.32 M138.22 71.2 C145.51 71.66, 151.38 72.37, 163.13 73.32" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(89.36514189812357 250.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M145.41 55.69 C151.09 60.78, 157.4 68.23, 163.13 73.32 M145.41 55.69 C150.52 60.48, 154.35 65.6, 163.13 73.32" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(433.1110687114803 250) rotate(0 31.09998321533203 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#f08c00" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">3: dup</text></g><g transform="translate(393.14524620608216 289.2974478460208) rotate(0 298.8397216796875 25)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">The `dup` instruction duplicates the top-of-stack reference</text><text x="0" y="42.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and pushes onto the top of the stack</text></g><g transform="translate(45.240141898123575 276.5) rotate(0 15.269989013671875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ref</text></g><g stroke-linecap="round"><g transform="translate(81.74014189812357 292) rotate(0 87.5 22)"><path d="M0.79 1.12 C30.02 8.49, 145.53 36.27, 174.71 43.52 M-0.26 0.67 C28.85 8.25, 144.31 37.82, 173.62 44.81" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(81.74014189812357 292) rotate(0 87.5 22)"><path d="M148.75 47.44 C156.66 46.16, 160.01 47.45, 173.62 44.81 M148.75 47.44 C156.56 46.86, 166.93 46.31, 173.62 44.81" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(81.74014189812357 292) rotate(0 87.5 22)"><path d="M152.88 30.84 C159.7 33.61, 162.05 38.92, 173.62 44.81 M152.88 30.84 C159.34 36.09, 168.26 41.38, 173.62 44.81" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(12.115141898123547 411.25) rotate(0 50 67)"><path d="M0 0 C19.69 1.07, 41.15 -0.13, 100 0 M0 0 C21.49 0.15, 42.58 -0.64, 100 0 M100 0 C100.48 53.16, 99.2 103.32, 100 134 M100 0 C101.39 46.8, 101.78 92.67, 100 134 M100 134 C66.76 133, 32.53 133.77, 0 134 M100 134 C67.78 134.08, 37 132.29, 0 134 M0 134 C1.53 90.27, 0.18 45.61, 0 0 M0 134 C-1.97 100.65, -0.29 66.6, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round"><g transform="translate(11.115141898123547 456.25) rotate(0 50.5 0.5)"><path d="M-0.49 0.94 C16.4 1.04, 84.35 1.01, 101.08 1.22 M1.45 0.39 C18.21 0.05, 83.39 -0.8, 100.18 -0.79" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(12.615141898123547 500.75) rotate(0 50.5 0.5)"><path d="M0.94 0.08 C17.71 0.15, 84.34 -0.33, 101.22 -0.1 M-0.02 -0.92 C16.56 -0.7, 83.37 0.81, 100.38 0.86" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(234.36514189812357 448.75) rotate(0 59 47)"><path d="M0 0 C30.93 -1.92, 63.12 0.7, 118 0 M0 0 C42.96 -0.18, 87.17 -0.8, 118 0 M118 0 C116.75 26.54, 120.01 50.16, 118 94 M118 0 C118.85 31.12, 118.03 61.86, 118 94 M118 94 C74.04 95.33, 32.57 93.16, 0 94 M118 94 C87.18 94.96, 57.79 94.75, 0 94 M0 94 C0.48 58.73, 1.28 23.94, 0 0 M0 94 C-0.24 73.85, 0.19 53.27, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(305.36514189812357 449.75) rotate(0 22.649986267089844 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Heap</text></g><g transform="translate(29.365141898123547 382.75) rotate(0 28.91998291015625 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Stack</text></g><g stroke-linecap="round" transform="translate(244.36514189812357 503.75) rotate(0 27.5 15)"><path d="M0 0 C18.28 0.78, 36.09 1.31, 55 0 M0 0 C15.43 -0.69, 30.64 -1.33, 55 0 M55 0 C54.01 7.15, 56.34 14.56, 55 30 M55 0 C55.66 10.51, 54.37 20.52, 55 30 M55 30 C38.77 29.36, 28.15 31.33, 0 30 M55 30 C43.04 30.56, 31.3 29.88, 0 30 M0 30 C-1.28 17.98, 1.03 10.96, 0 0 M0 30 C0.16 20.09, 0.38 10.71, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(47.365141898123575 421.75) rotate(0 15.269989013671875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ref</text></g><g stroke-linecap="round"><g transform="translate(90.36514189812357 440.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M0.79 0.65 C28.24 13.02, 138.38 62.15, 165.9 74.69 M-0.25 -0.05 C27.04 12.46, 137.87 63.73, 165.53 76.07" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(90.36514189812357 440.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M140.61 74.11 C151.65 76.58, 160.01 77.34, 165.53 76.07 M140.61 74.11 C150.35 74.01, 158.58 76.1, 165.53 76.07" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(90.36514189812357 440.8631306321763) rotate(0 82.39279176369308 37.4946599132646)"><path d="M147.7 58.55 C155.97 67.28, 161.5 74.25, 165.53 76.07 M147.7 58.55 C154.81 64.28, 160.38 72.23, 165.53 76.07" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(419.6149755175017 430.81225042906715) rotate(0 94.59992218017578 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#f08c00" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">4: invokespecial #3</text></g><g transform="translate(387.0312628834218 465.7106415908338) rotate(0 317.7896728515625 37.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">The `invokespecial` instruction pops the top-of-stack reference </text><text x="0" y="42.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and the just-allocated space will be initialized </text><text x="0" y="67.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">through invoking constructor</text></g><g stroke-linecap="round" transform="translate(18.115141898123547 628.25) rotate(0 50 67)"><path d="M0 0 C27.21 -2.16, 56.06 -0.53, 100 0 M0 0 C25.49 1.09, 50.43 -0.09, 100 0 M100 0 C101.25 34.81, 101.43 67.17, 100 134 M100 0 C99.98 48.89, 100.22 100.35, 100 134 M100 134 C64.98 132.82, 31.63 132.48, 0 134 M100 134 C78.36 135.42, 58.06 134.6, 0 134 M0 134 C-0.85 88.88, 0.92 45.52, 0 0 M0 134 C0.5 81.08, 1.13 28.5, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round"><g transform="translate(17.115141898123547 673.25) rotate(0 50.5 0.5)"><path d="M-0.72 -0.7 C15.86 -0.68, 83.7 1.05, 100.55 1.27 M1.11 1.55 C17.4 1.69, 83 -0.74, 99.37 -0.7" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(18.615141898123547 717.75) rotate(0 50.5 0.5)"><path d="M-0.7 -0.45 C15.98 -0.26, 84.39 0.22, 101.27 0.42 M1.14 -1.73 C17.58 -1.32, 84.05 1.03, 100.47 1.65" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(240.36514189812357 665.75) rotate(0 59 47)"><path d="M0 0 C28.82 -0.53, 56.11 0.05, 118 0 M0 0 C39.17 -0.63, 79.53 0.51, 118 0 M118 0 C117.68 31.64, 118.62 60.76, 118 94 M118 0 C118.17 27.15, 117.38 53.6, 118 94 M118 94 C81.3 93.08, 48.76 96.11, 0 94 M118 94 C90.15 94.37, 62.42 93.61, 0 94 M0 94 C0.76 71.07, -0.58 44.86, 0 0 M0 94 C0.1 67.58, 0.86 39.02, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(311.36514189812357 666.75) rotate(0 22.649986267089844 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Heap</text></g><g transform="translate(35.36514189812355 599.75) rotate(0 28.91998291015625 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Stack</text></g><g stroke-linecap="round" transform="translate(250.36514189812357 720.75) rotate(0 27.5 15)"><path d="M0 0 C17.37 0.86, 37.31 0.44, 55 0 M0 0 C15.61 -0.12, 30.33 -0.03, 55 0 M55 0 C55.53 7.58, 53.57 15.97, 55 30 M55 0 C55.43 11.77, 54.42 24.38, 55 30 M55 30 C44.69 28.87, 33.53 30.24, 0 30 M55 30 C38.16 29.69, 21.87 30.57, 0 30 M0 30 C0.17 20.13, -0.72 11.72, 0 0 M0 30 C-0.63 22.11, -0.38 13.21, 0 0" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(97.36514189812357 582.75) rotate(0 15.269989013671875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ref</text></g><g stroke-linecap="round"><g transform="translate(127.65758538749535 601.4438513166059) rotate(0 63.746570019007194 60.704299571049816)"><path d="M0.41 1.07 C21.75 21.29, 106.57 100.89, 127.65 121.07 M-0.83 0.59 C20.4 21.01, 105.67 102.5, 126.79 122.43" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(127.65758538749535 601.4438513166059) rotate(0 63.746570019007194 60.704299571049816)"><path d="M103.87 112.44 C111.81 115.32, 115.62 116.8, 126.79 122.43 M103.87 112.44 C112.66 116.31, 120.14 120.32, 126.79 122.43" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(127.65758538749535 601.4438513166059) rotate(0 63.746570019007194 60.704299571049816)"><path d="M115.66 100.05 C120.4 106.3, 121.04 111.12, 126.79 122.43 M115.66 100.05 C120.26 108.42, 123.49 116.91, 126.79 122.43" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask><g transform="translate(428.2009363095722 633.4493379904595) rotate(0 56.8299560546875 12.5)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#f08c00" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">7: astore_1</text></g><g transform="translate(389.6775587078126 675.0892343538062) rotate(0 340.979736328125 25)"><text x="0" y="17.619999999999997" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">The top-of-stack reference is popped and assigned to </text><text x="0" y="42.62" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">the element (`newTest`) at the position 1 of the LocalVariableTable</text></g><g transform="translate(234.74014189812357 570) rotate(0 78.76631927490234 42.39130434782609)"><text x="0" y="14.938695652173916" font-family="Virgil, Segoe UI Emoji" font-size="16.956521739130437px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">LocalVariableTable</text><text x="0" y="36.134347826086966" font-family="Virgil, Segoe UI Emoji" font-size="16.956521739130437px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">0 args</text><text x="0" y="57.33000000000001" font-family="Virgil, Segoe UI Emoji" font-size="16.956521739130437px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1 newTest</text><text x="0" y="78.52565217391306" font-family="Virgil, Segoe UI Emoji" font-size="16.956521739130437px" fill="#000000" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text></g><g stroke-linecap="round"><g transform="translate(230.60415477559212 622.0730316488514) rotate(0 -54.1325581609058 -16.281023290192607)"><path d="M0.67 -0.55 C-17.37 -6.08, -88.99 -27.43, -107.21 -32.79 M-0.43 1.77 C-18.63 -3.6, -89.41 -25.84, -107.61 -31.38" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(230.60415477559212 622.0730316488514) rotate(0 -54.1325581609058 -16.281023290192607)"><path d="M-82.64 -32.6 C-93.2 -30.23, -102.3 -32.13, -107.61 -31.38 M-82.64 -32.6 C-90.05 -31.68, -96.14 -32.09, -107.61 -31.38" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(230.60415477559212 622.0730316488514) rotate(0 -54.1325581609058 -16.281023290192607)"><path d="M-87.7 -16.26 C-96.35 -20.23, -103.5 -28.44, -107.61 -31.38 M-87.7 -16.26 C-93.61 -20.09, -98.25 -25.2, -107.61 -31.38" stroke="#000000" stroke-width="1" fill="none"></path></g></g><mask></mask></svg></div><p>The reason why the¬†<code>dup</code>¬†instruction is needed to duplicate the top element of the stack is because the next step,¬†<code>invokespecial</code>, needs to execute the default constructor, which will pop a reference from the top of the stack. If there is no¬†<code>dup</code>¬†to duplicate the top of the stack, it would result in an empty stack after¬†<code>invokespecial</code>, causing the newly created object to be lost.</p><p>This explains why¬†<code>new</code>¬†is not an atomic operation. Although in Java code it is just one line, at the bytecode level, it translates to key four instruction operations. Due to the instruction reordering, the three steps inside¬†<code>new</code>¬†can be reordered. In a multi-threaded environment, this can lead to issues in the singleton pattern mentioned above. Therefore, it‚Äôs necessary to add <code>volatile</code>¬†to the¬†<code>instance</code>¬†field to prevent reordering.</p><h2 id="1-5-Lazy-Singleton-Double-checked-Locking-DCL"><a href="#1-5-Lazy-Singleton-Double-checked-Locking-DCL" class="headerlink" title="1.5. Lazy Singleton - Double-checked Locking (DCL)"></a>1.5. Lazy Singleton - Double-checked Locking (DCL)</h2><p>Double Checked Locking is the most recommended lazy initialization singleton pattern, which ensures <span style="background:#fff88f">thread safety</span> and enables <span style="background:#fff88f">lazy loading</span>. The complete code is as follows:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.5. Lazy Singleton - Double-checked Locking (DCL)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Pros:</span></span><br><span class="line"><span class="comment"> * 1. lazy initialization</span></span><br><span class="line"><span class="comment"> * 2. can guarantee thread safety using double-checked locking (DCL)</span></span><br><span class="line"><span class="comment"> * 3. can reduce locking overhead</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Cons:</span></span><br><span class="line"><span class="comment"> * 1. more complex</span></span><br><span class="line"><span class="comment"> * 2. may influence its performance when facing a large number of initial `getInstance()` requests</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Best Use Cases:</span></span><br><span class="line"><span class="comment"> * 1. Use it when the singleton class holds heavy resources.</span></span><br><span class="line"><span class="comment"> * 2. Use it when we want to delay the creation of the singleton instance until it is actually needed.</span></span><br><span class="line"><span class="comment"> * 3. Use it when we consider both performance and lazy initialization.</span></span><br><span class="line"><span class="comment"> * 4. Avoid it when the singleton class is lightweight or always needed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonDoubleCheck</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingletonDoubleCheck instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDoubleCheck</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDoubleCheck <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDoubleCheck.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDoubleCheck</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-1-Reflection-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton"><a href="#1-5-1-Reflection-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton" class="headerlink" title="1.5.1. Reflection Attack on Lazy Singleton - Double-checked Locking Singleton"></a>1.5.1. Reflection Attack on Lazy Singleton - Double-checked Locking Singleton</h3><p>Typically, to avoid reflection attacks, we usually add a check in the private constructor to see if the¬†<code>instance</code> field¬†is null. If the <code>instance</code> is not null, we can assume that this singleton class has already created its object and throw an exception to prevent the reflection attack.</p><p>However, it is vulnerable to reflection attacks, which can break the intended singleton behaviour. Let‚Äôs see the following two cases:</p><ul><li>case 1 (‚àö): If we call <code>getInstance()</code> first and then call <code>constructor.newInstance()</code>, an error will be thrown to prevent reflection attacks.</li><li>case 2 (√ó): If we call <code>constructor.newInstance()</code> first and then call <code>getInstance()</code>, we will get two different instances leading to break singleton pattern.</li></ul><p>So, Lazy Singleton cannot prevent reflection attacks in all cases. The specific reasons are:</p><ol><li>Reflection allows access to private constructors. An attacker can use reflection mechanism to bypass the private constructor and create a new instance of a singleton class.</li><li>It lacks any inherent mechanism to check if the instance of a singleton class already exists when accessed via reflection.</li><li>Throwing an exception in the private constructor to prevent reflection attacks is not a foolproof plan, as an attacker can still manipulate the instance creation process.</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonDoubleCheckReflectionProof</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingletonDoubleCheckReflectionProof instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves, but cannot prevent constructor reflection</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDoubleCheckReflectionProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attack: the first call using reflection will still succeed, but subsequent attempts will fail.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDoubleCheckReflectionProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDoubleCheckReflectionProof.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDoubleCheckReflectionProof</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-2-Serialization-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton"><a href="#1-5-2-Serialization-Attack-on-Lazy-Singleton-Double-checked-Locking-Singleton" class="headerlink" title="1.5.2. Serialization Attack on Lazy Singleton - Double-checked Locking Singleton"></a>1.5.2. Serialization Attack on Lazy Singleton - Double-checked Locking Singleton</h3><p>Serializing and deserializing a class need to implement¬†<code>java.io.Serializable</code>, otherwise it‚Äôll throw an <code>java.io.NotSerializableException</code>. The general process of serialization and deserialization:</p><ol><li>Serializing the singleton class to generate a serialized file.</li><li>Reading the serialized file to obtain the instance of the singleton class via deserialization.</li><li>Comparing whether the serialized instance and the deserialized instance are the same.</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The class has to implement `java.io.Serializable` to avoid throwing `java.io.NotSerializableException`.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonDoubleCheckSerialization</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingletonDoubleCheckSerialization instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDoubleCheckSerialization</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attacks in all cases</span></span><br><span class="line">        iif (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDoubleCheckSerialization <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDoubleCheckSerialization.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDoubleCheckSerialization</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>First, let‚Äôs serialize the singleton class to generate a serialized file -&gt; read the serialized file and obtain the instance of the singleton class via deserialization -&gt; the deserialized instance is not the same as the instance of <code>getInstance()</code>, thereby breaking the singleton pattern. Here is the testing code:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSerializationAttackOnLazySingletonDoubleCheckSerialization</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LazySingletonDoubleCheckSerialization</span> <span class="variable">instance</span> <span class="operator">=</span> LazySingletonDoubleCheckSerialization.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Path</span> <span class="variable">serializedClassPath</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;TestSerialization-&quot;</span> + LazySingletonDoubleCheckSerialization.class.getSimpleName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize:</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(serializedClassPath))) &#123;</span><br><span class="line">        objectOutputStream.writeObject(instance);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deserialize: the constructor will not be called, the data will be initialized by reading from the byte stream.</span></span><br><span class="line">    LazySingletonDoubleCheckSerialization testSerializableInstance;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(serializedClassPath))) &#123;</span><br><span class="line">        testSerializableInstance = ((LazySingletonDoubleCheckSerialization) objectInputStream.readObject());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Assertions.assertSame(instance, testSerializableInstance); <span class="comment">// √ó</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The reason why the above deserialization generated a new object is that serialization has its own mechanism. It<font color="#00b050"> reads the byte stream data and does not call the constructor</font>. For non-Enum Singleton, to prevent serialization attacks, you need to add a version number like¬†<code>private static final long serialVersionUID = -1L;</code>, and also implement the¬†<code>readResolve()</code>¬†method, and return the instance of the class. In this way, you can get the same object. The code is as follows:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazySingletonDoubleCheckSerializationProof</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * It is mainly used for version control, ensuring compatibility between serialized and deserialized class versions.</span></span><br><span class="line"><span class="comment">     * If the `serialVersionUID` is not added during serialization, a version number will be automatically generated based on the current class data.</span></span><br><span class="line"><span class="comment">     * When deserializing, a version number will also be automatically generated.</span></span><br><span class="line"><span class="comment">     * If the two version numbers do not match (e.g. the class content is modified before deserialization), the following error will be reported:</span></span><br><span class="line"><span class="comment">     * `java.io.InvalidClassException: local class incompatible: stream classdesc serialVersionUID = -4190675925334731018, local class serialVersionUID = 1437610846000386433</span></span><br><span class="line"><span class="comment">     * Specifying a serialVersionUID can solve this problem.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingletonDoubleCheckSerializationProof instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDoubleCheckSerializationProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attacks in all cases</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDoubleCheckSerializationProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDoubleCheckSerializationProof.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDoubleCheckSerializationProof</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * For non-Enum Singleton pattern, when facing serialization attacks, the `readResolve()` method must be implemented.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ObjectStreamException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let‚Äôs analyse deserialization source code: <code>objectInputStream.readObject()</code> -&gt; <code>readObject(Object.class)</code> -&gt; <code>Object obj = readObject0(type, false);</code> -&gt; in the case-when for TC_OBJECTÔºö<code>readOrdinaryObject(unshared)</code>.</p><p>The key points of <code>readOrdinaryObject(unshared)</code> are:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">readOrdinaryObject</span><span class="params">(<span class="type">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        handles.lookupException(passHandle) == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// hasReadResolveMethodÔºöcheck if the current class has the¬†`readResolve()`¬†method.</span></span><br><span class="line">        desc.hasReadResolveMethod())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Calling the¬†`readResolve()`¬†method of the current class.</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">rep</span> <span class="operator">=</span> desc.invokeReadResolve(obj);</span><br><span class="line">        <span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">            rep = cloneArray(rep);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">            <span class="comment">// Filter the replacement object</span></span><br><span class="line">            <span class="keyword">if</span> (rep != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rep.getClass().isArray()) &#123;</span><br><span class="line">                    filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filterCheck(rep.getClass(), -<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The `rep` returned by `readResolve()` is assigned to the `obj`.</span></span><br><span class="line">            handles.setObject(passHandle, obj = rep);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">hasReadResolveMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    requireInitialized();</span><br><span class="line">    <span class="comment">// if the¬†`readResolveMethod`¬†is not null, it means the current class has the¬†`readResolve()`¬†method.</span></span><br><span class="line">    <span class="keyword">return</span> (readResolveMethod != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">ObjectStreamClass</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; cl)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the¬†`readResolve()`¬†method of the current class and assign it to the¬†`readResolveMethod`¬†variable</span></span><br><span class="line">    readResolveMethod = getInheritableMethod(cl, <span class="string">&quot;readResolve&quot;</span>, <span class="literal">null</span>, Object.class);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-3-Perfect-Version-of-Lazy-Singleton-Double-checked-Locking-Singleton"><a href="#1-5-3-Perfect-Version-of-Lazy-Singleton-Double-checked-Locking-Singleton" class="headerlink" title="1.5.3. Perfect Version of Lazy Singleton - Double-checked Locking Singleton"></a>1.5.3. Perfect Version of Lazy Singleton - Double-checked Locking Singleton</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lazy Singleton - Double-checked Locking (DCL): Perfect Version</span></span><br><span class="line"><span class="comment"> * 1. Using volatile + DCL to guarantee thread safety and minimize the use of synchronization</span></span><br><span class="line"><span class="comment"> * 2. Trying to use the private constructor checks to prevent reflection attacks, but cannot guarantee in all cases</span></span><br><span class="line"><span class="comment"> * 3. Using defined serialVersionUID and readResolve() to prevent serialization attacks</span></span><br><span class="line"><span class="comment"> * 4. Overriding clone() to prevent cloning attacks</span></span><br><span class="line"><span class="comment"> * 5. Using final class to prevent subclassing and avoid any subclass to break the singleton pattern</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LazySingletonDoubleCheckPerfect</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingletonDoubleCheckPerfect instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingletonDoubleCheckPerfect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attacks in all cases</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingletonDoubleCheckPerfect <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazySingletonDoubleCheckPerfect.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">LazySingletonDoubleCheckPerfect</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent serialization attacks</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent cloning</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="comment">// (1) throw an exception to prevent cloning</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CloneNotSupportedException</span>(<span class="string">&quot;Cloning of this singleton instance is not allowed&quot;</span>);</span><br><span class="line">        <span class="comment">// (2) or directly return the same instance from the clone method</span></span><br><span class="line">        <span class="comment">//return getInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="2-Eager-Singleton"><a href="#2-Eager-Singleton" class="headerlink" title="2. Eager Singleton"></a>2. Eager Singleton</h1><p>The eager Initialization pattern completes initialization when the class is loaded, relying on the <font color="#00b050">class loading mechanism</font> to ensure singleton behaviour without locking, thus achieving higher execution efficiency. However, due to instantiation during class loading, it lacks the advantage of lazy loading. If the instance is not used, it will be needlessly instantiated, wasting resources.</p><p>In the following two Eager Singleton examples, both are very simpler than the Lazy Singleton. These two patterns leverage the JVM‚Äôs class loading mechanism to ensure the uniqueness of the instance. Initialization occurs only once, and the JVM synchronizes the class loading process.</p><p>The class loading process involves: </p><ol><li><strong>Loading</strong>: the JVM locates and loads the class file‚Äôs bytecode into memory, generating the corresponding Class data structure.</li><li><strong>Linking</strong>: <strong>Verification</strong> (verifying the correctness of the loaded bytecode) ‚Üí <strong>Preparation</strong> (initializing static fields to their default values) ‚Üí <strong>Resolution</strong> (resolving symbolic references from the class file to actual references)</li><li><strong>Initialization</strong>: the <font color="#00b050">static initializers</font> and <font color="#00b050">static blocks</font> in the class are executed inside <code>&lt;clinit&gt;</code> and this process only happens the first time the class is used, such as an instance is created or a static method is invoked.</li><li><strong>Using</strong>: After a class is loaded and initialized, its instances can be created, methods can be invoked, and fields can be accessed.</li><li><strong>Unloading</strong>: When a class and its associated class loader are no longer in use and can be garbage collected, the class is removed from memory.</li></ol><p>As¬†<code>instance</code> variable¬†is a static member variable, its instantiation occurs during the class loading initialization phase. This phase involves executing the class constructor¬†<code>&lt;clinit&gt;()</code>¬†method, which the compiler automatically collects all static variables and static blocks within. Therefore,¬†<code>private static final EagerSingletonStaticConstant instance = new EagerSingletonStaticConstant();</code> and <code> static &#123; instance = new EagerSingletonStaticBlock(); &#125;</code>¬†also happen within this method. The JVM ensures that¬†<code>&lt;clinit&gt;()</code>¬†of a class is synchronized in a multi-threaded environment, guaranteeing thread safety.</p><blockquote><p>[!tip]<br>Some people may feel confused about why Eager Singleton is more wasting resources. They may think: ‚ÄòWhen that Eager Singleton class is never used, it appears to not invoke the constructor of the class‚Äô.</p><p>Actually, it is more of this kind of scenario, calling other methods of the class, rather than calling the <code>getInstance()</code>. For Eager Singleton, even if you don‚Äôt get the instance of the Eager Singleton and just call any other methods, it‚Äôll still trigger the class creation due to the class loading mechanism. But for Lazy Singleton, it won‚Äôt trigger class creation and just execute that other method.</p><p>Please refer to this example [EagerSingletonWastingReason.java](<a href="https://github.com/sissilab/DesignPattern-Lab/blob/master/src/main/java/com/sissilab/dp/ox1_creational/ox11_singleton/EagerSingletonWastingReason.java">DesignPattern-Lab&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;sissilab&#x2F;dp&#x2F;ox1_creational&#x2F;ox11_singleton&#x2F;EagerSingletonWastingReason.java at master ¬∑ sissilab&#x2F;DesignPattern-Lab (github.com)</a>) for more details.</p></blockquote><h2 id="2-1-Eager-Singleton-static-constant"><a href="#2-1-Eager-Singleton-static-constant" class="headerlink" title="2.1. Eager Singleton - static constant"></a>2.1. Eager Singleton - static constant</h2><p>It‚Äôs very simple to implement, but it may lead to wasting resources as the instance of the class is always created, whether it is required or not. It is also not easy to handle exception during the class creation.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2.1. Eager Singleton - static constant</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Pros:</span></span><br><span class="line"><span class="comment"> * 1. can guarantee the creation is thread-safe based on class loading mechanism without the need for synchronization</span></span><br><span class="line"><span class="comment"> * 2. more straightforward and easy to understand, and no need for additional code to handle lazy initialization or synchronization mechanisms</span></span><br><span class="line"><span class="comment"> * 3. no performance overhead during `getInstance()`, as the instance is created at the time of class loading</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Cons:</span></span><br><span class="line"><span class="comment"> * 1. may waste resources due to prematurely creation, especially for the resource-heavy singleton classes with large caches or database connections</span></span><br><span class="line"><span class="comment"> * 2. lack of lazy initialization</span></span><br><span class="line"><span class="comment"> * 3. inflexible to handle exceptions during the class creation using static constant</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Best Use Cases:</span></span><br><span class="line"><span class="comment"> * 1. Use it when the singleton class is relatively lightweight.</span></span><br><span class="line"><span class="comment"> * 2. Use it when the singleton class is frequently needed during the application&#x27;s lifecycle.</span></span><br><span class="line"><span class="comment"> * 3. Avoid it when lazy loading is preferable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EagerSingletonStaticConstant</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticConstant</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticConstant</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticConstant <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-1-Reflection-Attack-on-Eager-Singleton-static-constant"><a href="#2-1-1-Reflection-Attack-on-Eager-Singleton-static-constant" class="headerlink" title="2.1.1. Reflection Attack on Eager Singleton - static constant"></a>2.1.1. Reflection Attack on Eager Singleton - static constant</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticConstantReflectionProof</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EagerSingletonStaticConstantReflectionProof</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticConstantReflectionProof</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticConstantReflectionProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticConstantReflectionProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-2-Serialization-Attack-on-Eager-Singleton-static-constant"><a href="#2-1-2-Serialization-Attack-on-Eager-Singleton-static-constant" class="headerlink" title="2.1.2.  Serialization Attack on Eager Singleton - static constant"></a>2.1.2.  Serialization Attack on Eager Singleton - static constant</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticConstantSerializationProof</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EagerSingletonStaticConstantSerializationProof</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticConstantSerializationProof</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticConstantSerializationProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticConstantSerializationProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-3-Perfect-Version-of-Eager-Singleton-static-constant"><a href="#2-1-3-Perfect-Version-of-Eager-Singleton-static-constant" class="headerlink" title="2.1.3. Perfect Version of Eager Singleton - static constant"></a>2.1.3. Perfect Version of Eager Singleton - static constant</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Eager Singleton - static constant: Perfect Version</span></span><br><span class="line"><span class="comment"> * 1. Using static constant to create the singleton instance based on class loading mechanism</span></span><br><span class="line"><span class="comment"> * 2. Trying to use the private constructor checks to prevent reflection attacks, but cannot guarantee in all cases</span></span><br><span class="line"><span class="comment"> * 3. Using defined serialVersionUID and readResolve() to prevent serialization attacks</span></span><br><span class="line"><span class="comment"> * 4. Overriding clone() to prevent cloning attacks</span></span><br><span class="line"><span class="comment"> * 5. Using final class to prevent subclassing and avoid any subclass to break the singleton pattern</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EagerSingletonStaticConstantPerfect</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EagerSingletonStaticConstantPerfect</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticConstantPerfect</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticConstantPerfect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attacks in all cases</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticConstantPerfect <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent serialization attacks</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent cloning</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="comment">// (1) throw an exception to prevent cloning</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CloneNotSupportedException</span>(<span class="string">&quot;Cloning of this singleton instance is not allowed&quot;</span>);</span><br><span class="line">        <span class="comment">// (2) or directly return the same instance from the clone method</span></span><br><span class="line">        <span class="comment">//return getInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-Eager-Singleton-static-block"><a href="#2-2-Eager-Singleton-static-block" class="headerlink" title="2.2. Eager Singleton - static block"></a>2.2. Eager Singleton - static block</h2><p>Using static block to finish class instantiation may also lead to wasting resources due to class loading mechanism. But it‚Äôs easier to handle exception and do more things inside the static block.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2.2. Eager Singleton - static block</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Pros:</span></span><br><span class="line"><span class="comment"> * 1. can guarantee the creation is thread-safe based on class loading mechanism without the need for synchronization</span></span><br><span class="line"><span class="comment"> * 2. more straightforward and easy to understand, and no need for additional code to handle lazy initialization or synchronization mechanisms</span></span><br><span class="line"><span class="comment"> * 3. no performance overhead during `getInstance()`, as the instance is created at the time of class loading</span></span><br><span class="line"><span class="comment"> * 4. flexible to handle more complex logic or exception in static block during the creation</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Cons:</span></span><br><span class="line"><span class="comment"> * 1. may waste resources due to prematurely creation, especially for the resource-heavy singleton classes with large caches or database connections</span></span><br><span class="line"><span class="comment"> * 2. lack of lazy initialization</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Best Use Cases:</span></span><br><span class="line"><span class="comment"> * 1. Use it when the singleton class is relatively lightweight.</span></span><br><span class="line"><span class="comment"> * 2. Use it when the singleton class is frequently needed during the application&#x27;s lifecycle.</span></span><br><span class="line"><span class="comment"> * 3. Use it when we require complex initialization steps, as the static block gives flexibility to handle.</span></span><br><span class="line"><span class="comment"> * 4. Avoid it when lazy loading is preferable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticBlock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EagerSingletonStaticBlock instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticBlock</span>();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticBlock <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-1-Reflection-Attack-on-Eager-Singleton-static-block"><a href="#2-2-1-Reflection-Attack-on-Eager-Singleton-static-block" class="headerlink" title="2.2.1. Reflection Attack on Eager Singleton - static block"></a>2.2.1. Reflection Attack on Eager Singleton - static block</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticBlockReflectionProof</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class in the static block</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EagerSingletonStaticBlockReflectionProof instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticBlockReflectionProof</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticBlockReflectionProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticBlockReflectionProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-2-Serialization-Attack-on-Eager-Singleton-static-block"><a href="#2-2-2-Serialization-Attack-on-Eager-Singleton-static-block" class="headerlink" title="2.2.2. Serialization Attack on Eager Singleton - static block"></a>2.2.2. Serialization Attack on Eager Singleton - static block</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EagerSingletonStaticBlockSerializationProof</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class in the static block</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EagerSingletonStaticBlockSerializationProof instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticBlockSerializationProof</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticBlockSerializationProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticBlockSerializationProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prevent serialization attack</span></span><br><span class="line">    Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-3-Perfect-Version-of-Eager-Singleton-static-block"><a href="#2-2-3-Perfect-Version-of-Eager-Singleton-static-block" class="headerlink" title="2.2.3. Perfect Version of Eager Singleton - static block"></a>2.2.3. Perfect Version of Eager Singleton - static block</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Eager Singleton - static block: Perfect Version</span></span><br><span class="line"><span class="comment"> * 1. Using static block to create the singleton instance based on class loading mechanism</span></span><br><span class="line"><span class="comment"> * 2. Trying to use the private constructor checks to prevent reflection attacks, but cannot guarantee in all cases</span></span><br><span class="line"><span class="comment"> * 3. Using defined serialVersionUID and readResolve() to prevent serialization attacks</span></span><br><span class="line"><span class="comment"> * 4. Overriding clone() to prevent cloning attacks</span></span><br><span class="line"><span class="comment"> * 5. Using final class to prevent subclassing and avoid any subclass to break the singleton pattern</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EagerSingletonStaticBlockPerfect</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EagerSingletonStaticBlockPerfect instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">EagerSingletonStaticBlockPerfect</span>();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingletonStaticBlockPerfect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// cannot prevent reflection attacks in all cases</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingletonStaticBlockPerfect <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent serialization attacks</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent cloning</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="comment">// (1) throw an exception to prevent cloning</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CloneNotSupportedException</span>(<span class="string">&quot;Cloning of this singleton instance is not allowed&quot;</span>);</span><br><span class="line">        <span class="comment">// (2) or directly return the same instance from the clone method</span></span><br><span class="line">        <span class="comment">//return getInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-Static-Inner-Class-Singleton"><a href="#3-Static-Inner-Class-Singleton" class="headerlink" title="3.  Static Inner Class Singleton"></a>3.  Static Inner Class Singleton</h1><p>The Static Inner Class Singleton pattern essentially also utilises the classloader mechanism to ensure thread safety. Due to its characteristics, it can guarantee that the class initialization will only be triggered when it is actually used, which is also a form of lazy loading.</p><ul><li>Compared to <a href="#1-5-Lazy-Singleton-Double-checked-Locking-DCL">1.5. Lazy Singleton - Double-checked Locking (DCL)</a>, this pattern can also achieve the similar effect of lazy loading but with a simpler implementation.</li><li>Compared to <a href="#2-Eager-Singleton">2. Eager Singleton</a>, this pattern also utilises classloader mechanism to initialize and ensure only one instance of the class. When the class is loaded, the Eager Singleton will be instantiated, but the Static Inner Class Singleton may not be. This is because the instance will only be created when its static inner class <code>InstanceHolder</code> is used and loaded. So, the instance of <code>StaticInnerClassSingleton</code> won‚Äôt be created until the method <code>getInstance()</code> has been used, which can achieve the effect of lazy loading.</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 3. Static Inner Class Singleton</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Pros:</span></span><br><span class="line"><span class="comment"> * 1. lazy initialization based on the characteristics of static inner class</span></span><br><span class="line"><span class="comment"> * 2. can guarantee thread safety for the static initialization of the `InstanceHolder` class based on class loading mechanism</span></span><br><span class="line"><span class="comment"> * 3. can avoid synchronization overhead, unlike the DCL pattern</span></span><br><span class="line"><span class="comment"> * 4. relatively easier to understand compared to the DCL pattern</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Cons:</span></span><br><span class="line"><span class="comment"> * 1. inflexible to handle exceptions during the class creation</span></span><br><span class="line"><span class="comment"> * 2. unexpected issues due to class loading timing</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Best Use Cases:</span></span><br><span class="line"><span class="comment"> * 1. Use it when the singleton class holds heavy resources.</span></span><br><span class="line"><span class="comment"> * 2. Use it when we want to delay the creation of the singleton instance until it is actually needed.</span></span><br><span class="line"><span class="comment"> * 3. Avoid it when we require complex initialization steps</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticInnerClassSingleton</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// static inner class to provide the singleton instance of the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InstanceHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">StaticInnerClassSingleton</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaticInnerClassSingleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">StaticInnerClassSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticInnerClassSingleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// It is only here that the initialization of `InstanceHolder.instance` will be triggered</span></span><br><span class="line">        <span class="keyword">return</span> InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-1-Reflection-Attack-on-Static-Inner-Class-Singleton"><a href="#3-1-Reflection-Attack-on-Static-Inner-Class-Singleton" class="headerlink" title="3.1. Reflection Attack on Static Inner Class Singleton"></a>3.1. Reflection Attack on Static Inner Class Singleton</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StaticInnerSingletonReflectionProof</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// static inner class to provide the singleton instance of the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InstanceHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">StaticInnerSingletonReflectionProof</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaticInnerSingletonReflectionProof</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves, but cannot prevent constructor reflection</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">StaticInnerSingletonReflectionProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != InstanceHolder.instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticInnerSingletonReflectionProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// It is only here that the initialization of `InstanceHolder.instance` will be triggered.</span></span><br><span class="line">        <span class="keyword">return</span> InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-Serialization-Attack-on-Static-Inner-Class-Singleton"><a href="#3-2-Serialization-Attack-on-Static-Inner-Class-Singleton" class="headerlink" title="3.2. Serialization Attack on Static Inner Class Singleton"></a>3.2. Serialization Attack on Static Inner Class Singleton</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StaticInnerSingletonSerializationProof</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the `serialVersionUID` is not added during serialization, a version number will be automatically generated based on the current class data.</span></span><br><span class="line"><span class="comment">     * When deserializing, a version number will also be automatically generated.</span></span><br><span class="line"><span class="comment">     * If the two version numbers do not match (the class content is modified before deserialization), the following error will be reported:</span></span><br><span class="line"><span class="comment">     * `java.io.InvalidClassException: local class incompatible: stream classdesc serialVersionUID = -6193354024038071874, local class serialVersionUID = 3430229600994946531`</span></span><br><span class="line"><span class="comment">     * Specifying a serialVersionUID can solve this problem.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// static inner class to provide the singleton instance of the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InstanceHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">StaticInnerSingletonSerializationProof</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaticInnerSingletonSerializationProof</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves, but cannot prevent constructor reflection</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">StaticInnerSingletonSerializationProof</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != InstanceHolder.instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticInnerSingletonSerializationProof <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * For non-Enum Singleton pattern, when facing serialization attacks, the `readResolve()` method must be implemented.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ObjectStreamException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3-Perfect-Version-of-Static-Inner-Class-Singleton"><a href="#3-3-Perfect-Version-of-Static-Inner-Class-Singleton" class="headerlink" title="3.3. Perfect Version of Static Inner Class Singleton"></a>3.3. Perfect Version of Static Inner Class Singleton</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Static Inner Class Singleton: Perfect Version</span></span><br><span class="line"><span class="comment"> * 1. Using the characteristics of static inner class to provide lazy initialization and thread safety based on class loading mechanism</span></span><br><span class="line"><span class="comment"> * 2. Trying to use the private constructor checks to prevent reflection attacks, but cannot guarantee in all cases</span></span><br><span class="line"><span class="comment"> * 3. Using defined serialVersionUID and readResolve() to prevent serialization attacks</span></span><br><span class="line"><span class="comment"> * 4. Overriding clone() to prevent cloning attacks</span></span><br><span class="line"><span class="comment"> * 5. Using final class to prevent subclassing and avoid any subclass to break the singleton pattern</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StaticInnerSingletonPerfect</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicitly defining `serialVersionUID` can avoid potential incompatibility issues.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// static inner class to provide the singleton instance of the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InstanceHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">StaticInnerSingletonPerfect</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaticInnerSingletonPerfect</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor: restricts users from creating instances themselves</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">StaticInnerSingletonPerfect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// prevent reflection attack</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != InstanceHolder.instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This singleton instance already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticInnerSingletonPerfect <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StaticInnerSingletonPerfect.InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prevent serialization attacks</span></span><br><span class="line">    Object <span class="title function_">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException &#123;</span><br><span class="line">        <span class="comment">// during deserialization: returning the existing instance, instead of creating a new one.</span></span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent cloning</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="comment">// (1) throw an exception to prevent cloning</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CloneNotSupportedException</span>(<span class="string">&quot;Cloning of this singleton instance is not allowed&quot;</span>);</span><br><span class="line">        <span class="comment">// (2) or directly return the same instance from the clone method</span></span><br><span class="line">        <span class="comment">//return getInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-Enum-Singleton"><a href="#4-Enum-Singleton" class="headerlink" title="4. Enum Singleton"></a>4. Enum Singleton</h1><p>Enum is considered the best way to implement the singleton pattern. It not only leverages the class loading mechanism to guarantee thread safety, but also prevents the reconstruction of objects during deserialization, and avoids reflection attacks.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 4. Enum Singleton</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Pros:</span></span><br><span class="line"><span class="comment"> * 1. very easy to implement and the code is concise.</span></span><br><span class="line"><span class="comment"> * 2. inherently thread-safe as classloader mechanism, private constructor, and public static final instance field.</span></span><br><span class="line"><span class="comment"> * 3. can prevent reflection attacks because it&#x27;ll throw an IllegalArgumentException while calling `newInstance()`.</span></span><br><span class="line"><span class="comment"> * 4. inherently serializable and can prevent serialization attacks.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Cons:</span></span><br><span class="line"><span class="comment"> * 1. no lazy loading.</span></span><br><span class="line"><span class="comment"> * 2. cannot extend other classes because an enum class implicitly inherits `java.lang.Enum`.</span></span><br><span class="line"><span class="comment"> * 3. inconvenient to debug because some key codes are implicitly auto-generated, like private constructor, static initialization block, ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">EnumSingleton</span> &#123;</span><br><span class="line">    instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">anyMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let‚Äôs analyse the bytecode of the enum class. After compiling the¬†<code>EnumSingleton.java</code>¬†and generating the class¬†file through <code>javac -g EnumSingleton.java</code>, executing¬†<code>javap -v -p EnumSingleton.class</code>¬†to generate the bytecode file, as follows:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">Classfile /DesignPattern-Lab/src/main/java/com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">26</span>/08/<span class="number">2024</span>; size <span class="number">1195</span> bytes</span><br><span class="line">  MD5 checksum 1e21098493b1502d48f3a4fba5884dcc</span><br><span class="line">  Compiled from <span class="string">&quot;EnumSingleton.java&quot;</span></span><br><span class="line"><span class="comment">// enum class implicitly exted `java.lang.Enum`</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">com</span>.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton <span class="keyword">extends</span> <span class="title class_">java</span>.lang.Enum&lt;com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton&gt;</span><br><span class="line">  minor version: <span class="number">0</span></span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_FINAL, ACC_SUPER, ACC_ENUM</span><br><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Fieldref           #<span class="number">4.</span>#<span class="number">34</span>         <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton.$VALUES:[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">   #<span class="number">2</span> = Methodref          #<span class="number">35.</span>#<span class="number">36</span>        <span class="comment">// &quot;[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&quot;.clone:()Ljava/lang/Object;</span></span><br><span class="line">   #<span class="number">3</span> = Class              #<span class="number">14</span>            <span class="comment">// &quot;[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&quot;</span></span><br><span class="line">   #<span class="number">4</span> = Class              #<span class="number">37</span>            <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line">   #<span class="number">5</span> = Methodref          #<span class="number">10.</span>#<span class="number">38</span>        <span class="comment">// java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span></span><br><span class="line">   #<span class="number">6</span> = Methodref          #<span class="number">10.</span>#<span class="number">39</span>        <span class="comment">// java/lang/Enum.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line">   #<span class="number">7</span> = String             #<span class="number">11</span>            <span class="comment">// instance</span></span><br><span class="line">   #<span class="number">8</span> = Methodref          #<span class="number">4.</span>#<span class="number">39</span>         <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line">   #<span class="number">9</span> = Fieldref           #<span class="number">4.</span>#<span class="number">40</span>         <span class="comment">// com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton.instance:Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">  #<span class="number">10</span> = Class              #<span class="number">41</span>            <span class="comment">// java/lang/Enum</span></span><br><span class="line">  #<span class="number">11</span> = Utf8               instance</span><br><span class="line">  #<span class="number">12</span> = Utf8               Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">  #<span class="number">13</span> = Utf8               $VALUES</span><br><span class="line">  #<span class="number">14</span> = Utf8               [Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">  #<span class="number">15</span> = Utf8               values</span><br><span class="line">  #<span class="number">16</span> = Utf8               ()[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">  #<span class="number">17</span> = Utf8               Code</span><br><span class="line">  #<span class="number">18</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">19</span> = Utf8               valueOf</span><br><span class="line">  #<span class="number">20</span> = Utf8               (Ljava/lang/String;)Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">  #<span class="number">21</span> = Utf8               LocalVariableTable</span><br><span class="line">  #<span class="number">22</span> = Utf8               name</span><br><span class="line">  #<span class="number">23</span> = Utf8               Ljava/lang/String;</span><br><span class="line">  #<span class="number">24</span> = Utf8               &lt;init&gt;</span><br><span class="line">  #<span class="number">25</span> = Utf8               (Ljava/lang/String;I)V</span><br><span class="line">  #<span class="number">26</span> = Utf8               <span class="built_in">this</span></span><br><span class="line">  #<span class="number">27</span> = Utf8               Signature</span><br><span class="line">  #<span class="number">28</span> = Utf8               ()V</span><br><span class="line">  #<span class="number">29</span> = Utf8               anyMethod</span><br><span class="line">  #<span class="number">30</span> = Utf8               &lt;clinit&gt;</span><br><span class="line">  #<span class="number">31</span> = Utf8               Ljava/lang/Enum&lt;Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&gt;;</span><br><span class="line">  #<span class="number">32</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">33</span> = Utf8               EnumSingleton.java</span><br><span class="line">  #<span class="number">34</span> = NameAndType        #<span class="number">13</span>:#<span class="number">14</span>        <span class="comment">// $VALUES:[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">  #<span class="number">35</span> = Class              #<span class="number">14</span>            <span class="comment">// &quot;[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&quot;</span></span><br><span class="line">  #<span class="number">36</span> = NameAndType        #<span class="number">42</span>:#<span class="number">43</span>        <span class="comment">// clone:()Ljava/lang/Object;</span></span><br><span class="line">  #<span class="number">37</span> = Utf8               com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span><br><span class="line">  #<span class="number">38</span> = NameAndType        #<span class="number">19</span>:#<span class="number">44</span>        <span class="comment">// valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span></span><br><span class="line">  #<span class="number">39</span> = NameAndType        #<span class="number">24</span>:#<span class="number">25</span>        <span class="comment">// &quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line">  #<span class="number">40</span> = NameAndType        #<span class="number">11</span>:#<span class="number">12</span>        <span class="comment">// instance:Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">  #<span class="number">41</span> = Utf8               java/lang/Enum</span><br><span class="line">  #<span class="number">42</span> = Utf8               clone</span><br><span class="line">  #<span class="number">43</span> = Utf8               ()Ljava/lang/Object;</span><br><span class="line">  #<span class="number">44</span> = Utf8               (Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// The¬†`instance`¬†is a¬†`public static final`¬†field.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton instance;</span><br><span class="line">    descriptor: Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_ENUM</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the `private static final $VALUES` field holds all enum constants</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton[] $VALUES;</span><br><span class="line">    descriptor: [Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">    flags: ACC_PRIVATE, ACC_STATIC, ACC_FINAL, ACC_SYNTHETIC</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `values()` method is automatically generated by the compiler to return the array of defined enum constants.</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton[] values();</span><br><span class="line">    descriptor: ()[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">0</span>, args_size=<span class="number">0</span></span><br><span class="line">         <span class="number">0</span>: getstatic     #<span class="number">1</span>                  <span class="comment">// Field $VALUES:[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">         <span class="number">3</span>: invokevirtual #<span class="number">2</span>                  <span class="comment">// Method &quot;[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&quot;.clone:()Ljava/lang/Object;</span></span><br><span class="line">         <span class="number">6</span>: checkcast     #<span class="number">3</span>                  <span class="comment">// class &quot;[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&quot;</span></span><br><span class="line">         <span class="number">9</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">17</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton <span class="title function_">valueOf</span><span class="params">(java.lang.String)</span>;</span><br><span class="line">    descriptor: (Ljava/lang/String;)Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: ldc           #<span class="number">4</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line">         <span class="number">2</span>: aload_0</span><br><span class="line">         <span class="number">3</span>: invokestatic  #<span class="number">5</span>                  <span class="comment">// Method java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span></span><br><span class="line">         <span class="number">6</span>: checkcast     #<span class="number">4</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line">         <span class="number">9</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">17</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>      <span class="number">10</span>     <span class="number">0</span>  name   Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The private constructor with two arguments (String, int) is automatically generated.</span></span><br><span class="line">  <span class="keyword">private</span> com.sissilab.dp.ox1_creational.ox11_singleton.EnumSingleton();</span><br><span class="line">    descriptor: (Ljava/lang/String;I)V</span><br><span class="line">    flags: ACC_PRIVATE</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">3</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">         <span class="comment">// Loads the `this` reference onto the stack (from slot 0).</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="comment">// Loads the first argument (`name` of the enum constant) stored in local variable 1 onto the stack.</span></span><br><span class="line">         <span class="number">1</span>: aload_1</span><br><span class="line">         <span class="comment">// Loads the second argument (`ordinal` of the enum constant) stored in local variable 2 onto the stack.</span></span><br><span class="line">         <span class="number">2</span>: iload_2</span><br><span class="line">         <span class="comment">// calls superclass constructor `java.lang.Enum (String name, int ordinal)`</span></span><br><span class="line">         <span class="number">3</span>: invokespecial #<span class="number">6</span>                  <span class="comment">// Method java/lang/Enum.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line">         <span class="number">6</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">17</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">7</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line">    Signature: #<span class="number">28</span>                          <span class="comment">// ()V</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">anyMethod</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">0</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">21</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// static initialization block</span></span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">4</span>, locals=<span class="number">0</span>, args_size=<span class="number">0</span></span><br><span class="line">         <span class="comment">// allocates memory for an object of the class referenced by #4 -&gt; adds the reference to the top of the operand stack</span></span><br><span class="line">         <span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">4</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line">         <span class="comment">// dup: duplicates the top stack value -&gt; adds the duplicated reference to the top of the operand stack</span></span><br><span class="line">         <span class="number">3</span>: dup</span><br><span class="line">         <span class="comment">// ldc: loads String instance onto the stack Ôºà`String name`Ôºâ</span></span><br><span class="line">         <span class="number">4</span>: ldc           #<span class="number">7</span>                  <span class="comment">// String instance</span></span><br><span class="line">         <span class="comment">// iconst_0: pushes the integer constant 0 onto the stack (`int ordinal`)</span></span><br><span class="line">         <span class="number">6</span>: iconst_0</span><br><span class="line">         <span class="comment">// invokespecialÔºöinvokes the constructor EnumSingleton(String, int) to initialize</span></span><br><span class="line">         <span class="number">7</span>: invokespecial #<span class="number">8</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line">        <span class="comment">// putstatic: assigns the created instance to the static field¬†`instance` of EnumSingleton</span></span><br><span class="line">        <span class="number">10</span>: putstatic     #<span class="number">9</span>                  <span class="comment">// Field instance:Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">        <span class="comment">// iconst_1: pushes the integer 1 (the size of the array to be created) onto the stack.</span></span><br><span class="line">        <span class="number">13</span>: iconst_1</span><br><span class="line">        <span class="comment">// anewarray: creates a new array of EnumSingleton objects (size=1)</span></span><br><span class="line">        <span class="number">14</span>: anewarray     #<span class="number">4</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line">        <span class="comment">// dup: duplicates the reference to the array on the stack</span></span><br><span class="line">        <span class="number">17</span>: dup</span><br><span class="line">        <span class="comment">// iconst_0: pushes the integer 0 (the index of the array) onto the stack</span></span><br><span class="line">        <span class="number">18</span>: iconst_0</span><br><span class="line">        <span class="comment">// getstatic: get static field `instance`</span></span><br><span class="line">        <span class="number">19</span>: getstatic     #<span class="number">9</span>                  <span class="comment">// Field instance:Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">        <span class="comment">// aastore: stores the instance into the array at index 0</span></span><br><span class="line">        <span class="number">22</span>: aastore</span><br><span class="line">        <span class="comment">// putstatic: stores the array into the static field `$VALUES` (it holds all the enum constants in the order)</span></span><br><span class="line">        <span class="number">23</span>: putstatic     #<span class="number">1</span>                  <span class="comment">// Field $VALUES:[Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br><span class="line">        <span class="number">26</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">18</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">17</span>: <span class="number">13</span></span><br><span class="line">&#125;</span><br><span class="line">Signature: #<span class="number">31</span>                          <span class="comment">// Ljava/lang/Enum&lt;Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;&gt;;</span></span><br><span class="line">SourceFile: <span class="string">&quot;EnumSingleton.java&quot;</span></span><br></pre></td></tr></table></figure><p>In fact, the initialization process happens in the static initialization block (<code>static &#123;&#125;</code>, it‚Äôll be executed when the class is first loaded.), the key code is as follows:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// allocates memory for an object of the class referenced by #4 -&gt; adds the reference to the top of the operand stack</span></span><br><span class="line"><span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">4</span>                  <span class="comment">// class com/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dup: duplicates the top stack value -&gt; adds the duplicated reference to the top of the operand stack</span></span><br><span class="line"><span class="number">3</span>: dup</span><br><span class="line"></span><br><span class="line"><span class="comment">// ldc: loads String instance onto the stack</span></span><br><span class="line"><span class="number">4</span>: ldc           #<span class="number">7</span>                  <span class="comment">// String instance</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// iconst_0: pushes the integer constant 0 onto the stack</span></span><br><span class="line"><span class="number">6</span>: iconst_0</span><br><span class="line"></span><br><span class="line"><span class="comment">// invokespecialÔºöinvokes the constructor EnumSingleton(String, int) to initialize</span></span><br><span class="line"><span class="number">7</span>: invokespecial #<span class="number">8</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:(Ljava/lang/String;I)V</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// putstatic: assigns the created instance to the static field¬†`instance` of EnumSingleton</span></span><br><span class="line"><span class="number">10</span>: putstatic     #<span class="number">9</span>                  <span class="comment">// Field instance:Lcom/sissilab/dp/ox1_creational/ox11_singleton/EnumSingleton;</span></span><br></pre></td></tr></table></figure><h2 id="4-1-Reflection-Attack-on-Enum-Singleton"><a href="#4-1-Reflection-Attack-on-Enum-Singleton" class="headerlink" title="4.1. Reflection Attack on Enum Singleton"></a>4.1. Reflection Attack on Enum Singleton</h2><p>When attempting to obtain the instance of an enum class through reflection, an error will be thrown: <code>java.lang.IllegalArgumentException: Cannot reflectively create enum objects</code>. This effectively prevents reflection attacks</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReflectionAttackOnEnumSingleton</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">    <span class="comment">// get the constructor: only automatically generate a private constructor with two parameters, like `private EnumSingleton(String, int)`</span></span><br><span class="line">    Constructor&lt;EnumSingleton&gt; constructor = EnumSingleton.class.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">    <span class="comment">// set the accessibility of the constructor</span></span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// reflectInstance: create the instance through constructor</span></span><br><span class="line">    <span class="type">EnumSingleton</span> <span class="variable">reflectInstance</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;instance&quot;</span>, <span class="number">0</span>); <span class="comment">// java.lang.IllegalArgumentException: Cannot reflectively create enum objects</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// instance: get the instance through the normal public static final `instance` field</span></span><br><span class="line">    <span class="type">EnumSingleton</span> <span class="variable">instance</span> <span class="operator">=</span> EnumSingleton.instance;</span><br><span class="line"></span><br><span class="line">    Assertions.assertSame(reflectInstance, instance); <span class="comment">// √ó</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In fact, the error is thrown during <code>public T newInstance(Object ... initargs)</code>. The following source code indicates that there is an explicit check about whether current class is enum type and the <code>IllegalArgumentException</code> will be thrown if yes. So, Enum Singleton can prevent reflection attacks.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Constructor</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Executable</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">newInstance</span><span class="params">(Object ... initargs)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!override) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</span><br><span class="line">                Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">                checkAccess(caller, clazz, <span class="literal">null</span>, modifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If current class is enum type, the `IllegalArgumentException` will be thrown.</span></span><br><span class="line">        <span class="keyword">if</span> ((clazz.getModifiers() &amp; Modifier.ENUM) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Cannot reflectively create enum objects&quot;</span>);</span><br><span class="line">        <span class="type">ConstructorAccessor</span> <span class="variable">ca</span> <span class="operator">=</span> constructorAccessor;   <span class="comment">// read volatile</span></span><br><span class="line">        <span class="keyword">if</span> (ca == <span class="literal">null</span>) &#123;</span><br><span class="line">            ca = acquireConstructorAccessor();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">inst</span> <span class="operator">=</span> (T) ca.newInstance(initargs);</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-2-Serialization-Attack-on-Enum-Singleton"><a href="#4-2-Serialization-Attack-on-Enum-Singleton" class="headerlink" title="4.2. Serialization Attack on Enum Singleton"></a>4.2. Serialization Attack on Enum Singleton</h2><p>Every enum classes implicitly inherit from <code>java.lang.Enum</code> abstract class that implements <code>java.io.Serializable</code>, which means enum classes can support serialization and deserialization. Thanks to its built-in mechanisms, Enum Singleton is inherently safe from serialization attacks, for no new instances of enum constants are created during deserialization.</p><p>Let‚Äôs see what happened about Enum Singleton in deserialization source code. Within <code>readObject0(type, false)</code> method, in the case-when for TC_ENUMÔºö‚Äì&gt; <code>readEnum(boolean unshared)</code>Ôºö</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Enum&lt;?&gt; readEnum(<span class="type">boolean</span> unshared) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// only objects serialized as enum are processed</span></span><br><span class="line">    <span class="keyword">if</span> (bin.readByte() != TC_ENUM) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectStreamClass</span> <span class="variable">desc</span> <span class="operator">=</span> readClassDesc(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// If the class isn&#x27;t an enum, an InvalidClassException will be thrown. </span></span><br><span class="line">    <span class="keyword">if</span> (!desc.isEnum()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;non-enum class: &quot;</span> + desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">enumHandle</span> <span class="operator">=</span> handles.assign(unshared ? unsharedMarker : <span class="literal">null</span>);</span><br><span class="line">    <span class="type">ClassNotFoundException</span> <span class="variable">resolveEx</span> <span class="operator">=</span> desc.getResolveException();</span><br><span class="line">    <span class="keyword">if</span> (resolveEx != <span class="literal">null</span>) &#123;</span><br><span class="line">        handles.markException(enumHandle, resolveEx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the name of the enum constant, e.g. `instance` (Each constant name must be unique within an enum.)</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> readString(<span class="literal">false</span>);</span><br><span class="line">    Enum&lt;?&gt; result = <span class="literal">null</span>;</span><br><span class="line">    Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">    <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="comment">// find the constant using the enum class (e.g. `EnumSingleton`) and the constant name (e.g. `instance`)</span></span><br><span class="line">            <span class="comment">// It&#x27;s the key part that no new enum instances are created, regardless of how many times the enum is serialized and deserialized.</span></span><br><span class="line">            Enum&lt;?&gt; en = Enum.valueOf((Class)cl, name);</span><br><span class="line">            result = en;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(</span><br><span class="line">                <span class="string">&quot;enum constant &quot;</span> + name + <span class="string">&quot; does not exist in &quot;</span> +</span><br><span class="line">                cl).initCause(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!unshared) &#123;</span><br><span class="line">            <span class="comment">// In the default mode (Shared Mode), the `unshared` is false. This means that if an object appears multiple times in a serialized stream, all references to that object will point to the same deserialized instance.</span></span><br><span class="line">            <span class="comment">// The existing handle (`Object[] entries`) will be updated, which can ensure that the same enum instance is reused, especially for Enum Singleton.</span></span><br><span class="line">            handles.setObject(enumHandle, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handles.finish(enumHandle);</span><br><span class="line">    passHandle = enumHandle;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Enum</span>&lt;T&gt;&gt; T <span class="title function_">valueOf</span><span class="params">(Class&lt;T&gt; enumType, String name)</span> &#123;</span><br><span class="line">    <span class="comment">// get the enum constant by its name from an internal map (`Map&lt;String, T&gt; enumConstantDirectory`)</span></span><br><span class="line">    <span class="comment">// There&#x27;s a pre-built internal map within `enumConstantDirectory()` that contains all enum constants loaded into memory, which ensures the uniqueness of each enum constant.</span></span><br><span class="line">    <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> enumType.enumConstantDirectory().get(name);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Name is null&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">        <span class="string">&quot;No enum constant &quot;</span> + enumType.getCanonicalName() + <span class="string">&quot;.&quot;</span> + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3-Perfect-Version-of-Enum-Singleton"><a href="#4-3-Perfect-Version-of-Enum-Singleton" class="headerlink" title="4.3. Perfect Version of Enum Singleton"></a>4.3. Perfect Version of Enum Singleton</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use this singleton:</span></span><br><span class="line"><span class="comment"> * `EnumSingletonPerfect.instance.anyMethod();`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">EnumSingletonPerfect</span> &#123;</span><br><span class="line">    instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">anyMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Access the lazy-loaded resource:</span></span><br><span class="line"><span class="comment">     * `EnumSingletonPerfect.instance.getExpensiveResource().useResource();`</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Using a static inner class to implement lazy loading of heavy resources</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyHeavyResource</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">HeavyResource</span> <span class="variable">RESOURCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeavyResource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HeavyResource <span class="title function_">getExpensiveResource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHeavyResource.RESOURCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This static inner class represents a heavy resource.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HeavyResource</span> &#123;</span><br><span class="line">        HeavyResource() &#123;</span><br><span class="line">            <span class="comment">// simulate expensive initialization... need a lot of time to load</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">useResource</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Use this heavy resource...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5-Application-in-Source-Code"><a href="#5-Application-in-Source-Code" class="headerlink" title="5. Application in Source Code"></a>5. Application in Source Code</h1><h2 id="5-1-java-lang-Runtime-Eager-Singleton-static-constant"><a href="#5-1-java-lang-Runtime-Eager-Singleton-static-constant" class="headerlink" title="5.1. java.lang.Runtime (Eager Singleton - static constant)"></a>5.1. java.lang.Runtime (Eager Singleton - static constant)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Eager initialization: the single instance `currentRuntime` is initialized when the class is loaded, ensuring that the instance is created early (eagerly) and is thread-safe.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Runtime</span> &#123;</span><br><span class="line">    <span class="comment">// holds the singleton instance: initialized when loading the class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runtime</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// private constructor: prevents external instantiation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Runtime</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Runtime <span class="title function_">getRuntime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentRuntime;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-2-org-quartz-impl-SchedulerRepository-Lazy-Singleton-synchronized"><a href="#5-2-org-quartz-impl-SchedulerRepository-Lazy-Singleton-synchronized" class="headerlink" title="5.2. org.quartz.impl.SchedulerRepository (Lazy Singleton - synchronized)"></a>5.2. org.quartz.impl.SchedulerRepository (Lazy Singleton - synchronized)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scheduler scheduler = new StdSchedulerFactory().getScheduler(); -&gt; SchedulerRepository schedRep = SchedulerRepository.getInstance();</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchedulerRepository</span> &#123;</span><br><span class="line">    <span class="comment">// holds the singleton instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SchedulerRepository inst;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// private constructor: prevents external instantiation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SchedulerRepository</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance: use static synchronized method to ensure thread safety</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SchedulerRepository <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inst == <span class="literal">null</span>) &#123;</span><br><span class="line">            inst = <span class="keyword">new</span> <span class="title class_">SchedulerRepository</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-3-Spring-org-springframework-beans-factory-support-DefaultSingletonBeanRegistry-Lazy-Singleton-Double-checked-Locking"><a href="#5-3-Spring-org-springframework-beans-factory-support-DefaultSingletonBeanRegistry-Lazy-Singleton-Double-checked-Locking" class="headerlink" title="5.3. Spring - org.springframework.beans.factory.support.DefaultSingletonBeanRegistry (Lazy Singleton - Double-checked Locking)"></a>5.3. Spring - org.springframework.beans.factory.support.DefaultSingletonBeanRegistry (Lazy Singleton - Double-checked Locking)</h2><p>Spring‚Äôs singleton pattern: When a bean is defined in the Spring application context without explicitly specified scope, Spring will treat it as a singleton by default. This means that Spring will create only one instance of the bean that can be shared by all the classes. By leveraging this kind of singleton pattern in Spring, we can benefit from efficient memory management, centralized bean configuration, and the sharing and reuse of bean instances across the application.</p><p>In Spring, the process of loading a singleton typically starts from the¬†<code>getBean()</code>¬†method of the¬†<code>org.springframework.beans.factory.BeanFactory</code>, whose default implementation is the abstract class¬†<code>org.springframework.beans.factory.support.AbstractBeanFactory</code>. The various¬†<code>getBean()</code>¬†methods ultimately call the¬†<code>doGetBean()</code>¬†method of¬†<code>AbstractBeanFactory</code>, such as¬†<code>org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.beans.factory.support.AbstractBeanFactory</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title class_">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableBeanFactory</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// get the transformed bean name, in case the name contains illegal characters</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> transformedBeanName(name);</span><br><span class="line">        Object bean;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></span><br><span class="line">        <span class="comment">// In general, it will return null the first time a bean is requested.</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span> &amp;&amp; args == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// get the object for the given bean instance, either the bean instance itself or its created object in case of a FactoryBean. </span></span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">                <span class="comment">// Create bean instance.</span></span><br><span class="line">                <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">                    <span class="comment">// If the bean is a singleton, it will enter the overloaded¬†`getSingleton()`¬†method.</span></span><br><span class="line">                    sharedInstance = getSingleton(beanName, <span class="keyword">new</span> <span class="title class_">ObjectFactory</span>&lt;Object&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                                destroySingleton(beanName);</span><br><span class="line">                                <span class="keyword">throw</span> ex;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> (T) bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The statement¬†<code>Object sharedInstance = getSingleton(beanName);</code>¬†within the¬†<code>getBean()</code>¬†method is the core implementation of the Singleton pattern (Double Check) in Spring. The¬†<code>getSingleton()</code>¬†method is defined in the parent class of¬†<code>AbstractBeanFactory</code>, which is¬†<code>DefaultSingletonBeanRegistry</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title class_">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title class_">SingletonBeanRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache of singleton objects (fully initialized singleton beans): bean name -&gt; bean instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache of early singleton objects (currently being created singleton beans, partially created): bean name -&gt; bean instance</span></span><br><span class="line">    <span class="comment">// It&#x27;s the key to resolving circular dependencies.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache of singleton factories: bean name -&gt; ObjectFactory</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getSingleton(beanName, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the bean from cache based on DCL pattern</span></span><br><span class="line">    <span class="comment">// `singletonObjects` -&gt; `earlySingletonObjects` -&gt; `singletonFactories` -&gt; create the singleon bean through `singletonFactory.getObject()`</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, <span class="type">boolean</span> allowEarlyReference)</span> &#123;</span><br><span class="line">        <span class="comment">// (1) `singletonObjects`: check if the cache contains the bean</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// The singleton in `singletonObjects` is not found. &amp;&amp; The singleton bean is currently being created.</span></span><br><span class="line">        <span class="comment">// isSingletonCurrentlyInCreation(beanName): If it&#x27;s true, when the singleton bean is in the process of being created but not yet fully initialized.</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123; <span class="comment">// synchronized on the `singletonObjects` map to ensure thread safety</span></span><br><span class="line">                <span class="comment">// (2) `earlySingletonObjects`: this cache holds beans that are in the process of being created.</span></span><br><span class="line">                singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                <span class="comment">// The singleton in `earlySingletonObjects` is not found. &amp;&amp; `allowEarlyReference` is true.</span></span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                    <span class="comment">// When certain methods require early initialization, the¬†`addSingleFactory()`¬†method is called to store the corresponding¬†`ObjectFactory`¬†initialization strategy in the¬†`singletonFactories`¬†map.</span></span><br><span class="line">                    <span class="comment">// (3) `singletonFactories`: get the ObjectFactory by the beanName</span></span><br><span class="line">                    ObjectFactory&lt;?&gt; singletonFactory = <span class="built_in">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// create and get the bean</span></span><br><span class="line">                        singletonObject = singletonFactory.getObject();</span><br><span class="line">                        <span class="comment">// update the two caches: `earlySingletonObjects` and `singletonFactories` are mutually exclusive.</span></span><br><span class="line">                        <span class="built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                        <span class="built_in">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In general, the first time¬†<code>getSingleton()</code>¬†is called in¬†<code>doGetBean()</code>, the corresponding bean instance is not found in the cache. It then proceeds to the¬†<code>if (mbd.isSingleton()) &#123; &#125;</code>¬†block, where the overloaded¬†<code>getSingleton()</code>¬†method is called. Within this method, the bean is instantiated, and the instance is then cached in the¬†<code>singletonObjects</code>¬†map, allowing for the direct return of the singleton bean in subsequent requests.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title class_">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title class_">SingletonBeanRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;</span><br><span class="line">        Assert.notNull(beanName, <span class="string">&quot;&#x27;beanName&#x27; must not be null&quot;</span>);</span><br><span class="line">        <span class="comment">// Since the creation process involves operations on the¬†`singletonObjects`, locking is required.</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">            <span class="comment">// 1. try to get the bean from `singletonObjects` map again and check if the bean has already been loaded. If the bean has been loaded, it is directly returned.</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 2. If the current BeanFactory is in the process of being destroyed, an exception is thrown directly, and the creation of the singleton bean is not allowed.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationNotAllowedException</span>(beanName,</span><br><span class="line">                                                              <span class="string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +</span><br><span class="line">                                                              <span class="string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3. Some preparatory work before creating the bean: </span></span><br><span class="line">                <span class="comment">// The beanName is recorded as currently in the process of being loaded (added to the¬†`singletonsCurrentlyInCreation`¬†cache).</span></span><br><span class="line">                <span class="comment">// If the bean is already in the process of being loaded, an exception is thrown.</span></span><br><span class="line">                <span class="comment">// It&#x27;s to address the issue of circular references.</span></span><br><span class="line">                beforeSingletonCreation(beanName);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">newSingleton</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">recordSuppressedExceptions</span> <span class="operator">=</span> (<span class="built_in">this</span>.suppressedExceptions == <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.suppressedExceptions = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;Exception&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 4. Get the bean instance through a callback mechanism.</span></span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    newSingleton = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                    <span class="comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span></span><br><span class="line">                    <span class="comment">// if yes, proceed with it since the exception indicates that state.</span></span><br><span class="line">                    singletonObject = <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> ex;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (Exception suppressedException : <span class="built_in">this</span>.suppressedExceptions) &#123;</span><br><span class="line">                            ex.addRelatedCause(suppressedException);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.suppressedExceptions = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 5. Post-processing steps after the singleton bean is loaded: </span></span><br><span class="line">                    <span class="comment">// The record of the bean being currently in the process of creation is removed (the beanName is removed from the¬†`singletonsCurrentlyInCreation`¬†cache).</span></span><br><span class="line">                    afterSingletonCreation(beanName); <span class="comment">// ‰ªé singletonsCurrentlyInCreation ‰∏≠ÁßªÈô§ËØ• beanName</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">                    <span class="comment">// 6. added to the `singletonObjects` cache and removed from other auxiliary caches (e.g. `singletonFactories`, `earlySingletonObjects`)</span></span><br><span class="line">                    addSingleton(beanName, singletonObject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-4-Spring-org-springframework-core-ReactiveAdapterRegistry-Lazy-Singleton-Double-checked-Locking"><a href="#5-4-Spring-org-springframework-core-ReactiveAdapterRegistry-Lazy-Singleton-Double-checked-Locking" class="headerlink" title="5.4. Spring - org.springframework.core.ReactiveAdapterRegistry (Lazy Singleton - Double-checked Locking)"></a>5.4. Spring - org.springframework.core.ReactiveAdapterRegistry (Lazy Singleton - Double-checked Locking)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactiveAdapterRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> ReactiveAdapterRegistry sharedInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ReactiveAdapterRegistry <span class="title function_">getSharedInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReactiveAdapterRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> sharedInstance;</span><br><span class="line">        <span class="keyword">if</span> (registry == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ReactiveAdapterRegistry.class) &#123;</span><br><span class="line">                registry = sharedInstance;</span><br><span class="line">                <span class="keyword">if</span> (registry == <span class="literal">null</span>) &#123;</span><br><span class="line">                    registry = <span class="keyword">new</span> <span class="title class_">ReactiveAdapterRegistry</span>();</span><br><span class="line">                    sharedInstance = registry;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> registry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-5-Spring-org-springframework-aop-framework-ProxyFactoryBean-Lazy-Singleton-synchronized"><a href="#5-5-Spring-org-springframework-aop-framework-ProxyFactoryBean-Lazy-Singleton-synchronized" class="headerlink" title="5.5. Spring - org.springframework.aop.framework.ProxyFactoryBean (Lazy Singleton - synchronized)"></a>5.5. Spring - org.springframework.aop.framework.ProxyFactoryBean (Lazy Singleton - synchronized)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyFactoryBean</span> <span class="keyword">extends</span> <span class="title class_">ProxyCreatorSupport</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Object&gt;, BeanClassLoaderAware, BeanFactoryAware &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Object singletonInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controls access to the singleton instance: use synchronized method to ensure thread safety</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> Object <span class="title function_">getSingletonInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.singletonInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.targetSource = freshTargetSource();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.autodetectInterfaces &amp;&amp; getProxiedInterfaces().length == <span class="number">0</span> &amp;&amp; !isProxyTargetClass()) &#123;</span><br><span class="line">                <span class="comment">// Rely on AOP infrastructure to tell us what interfaces to proxy.</span></span><br><span class="line">                Class&lt;?&gt; targetClass = getTargetClass();</span><br><span class="line">                <span class="keyword">if</span> (targetClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FactoryBeanNotInitializedException</span>(<span class="string">&quot;Cannot determine target class for proxy&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                setInterfaces(ClassUtils.getAllInterfacesForClass(targetClass, <span class="built_in">this</span>.proxyClassLoader));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Initialize the shared singleton instance.</span></span><br><span class="line">            <span class="built_in">super</span>.setFrozen(<span class="built_in">this</span>.freezeProxy);</span><br><span class="line">            <span class="comment">// create AOP dynamic proxy and get the instance</span></span><br><span class="line">            <span class="built_in">this</span>.singletonInstance = getProxy(createAopProxy());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.singletonInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-6-Tomcat-org-apache-catalina-webresources-TomcatURLStreamHandlerFactory-Lazy-Singleton-Double-checked-Locking"><a href="#5-6-Tomcat-org-apache-catalina-webresources-TomcatURLStreamHandlerFactory-Lazy-Singleton-Double-checked-Locking" class="headerlink" title="5.6. Tomcat - org.apache.catalina.webresources.TomcatURLStreamHandlerFactory (Lazy Singleton - Double-checked Locking)"></a>5.6. Tomcat - org.apache.catalina.webresources.TomcatURLStreamHandlerFactory (Lazy Singleton - Double-checked Locking)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatURLStreamHandlerFactory</span> <span class="keyword">implements</span> <span class="title class_">URLStreamHandlerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// holds the singleton instance: add volatile to prevent reordering</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">TomcatURLStreamHandlerFactory</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TomcatURLStreamHandlerFactory <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        getInstanceInternal(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use double-checked locking</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TomcatURLStreamHandlerFactory <span class="title function_">getInstanceInternal</span><span class="params">(<span class="type">boolean</span> register)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">var1</span> <span class="operator">=</span> TomcatURLStreamHandlerFactory.class;</span><br><span class="line">            <span class="keyword">synchronized</span>(TomcatURLStreamHandlerFactory.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">TomcatURLStreamHandlerFactory</span>(register);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul><li><a href="https://en.wikipedia.org/wiki/Singleton_pattern">Singleton pattern - Wikipedia</a></li><li><a href="https://java-design-patterns.com/patterns/singleton/">Singleton Pattern in Java: Implementing Global Access Points in Java Applications | Java Design Patterns (java-design-patterns.com)</a></li><li><a href="https://www.runoob.com/design-pattern/singleton-pattern.html">ËèúÈ∏üÊïôÁ®ã-Âçï‰æãÊ®°Âºè</a></li></ul>]]></content>
        
        
        <categories>
            
            <category> 23 Design Patterns </category>
            
            <category> 1. Creational Pattern </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Design_Pattern </tag>
            
            <tag> Creational_Pattern </tag>
            
        </tags>
        
    </entry>
    
    
    
    <entry>
        <title>0. Design Pattern Overview</title>
        <link href="/en/design-pattern/design-pattern-overview/"/>
        <url>/en/design-pattern/design-pattern-overview/</url>
        
        <content type="html"><![CDATA[<p><strong>1. Creational Pattern:</strong></p><ul><li><input checked="" disabled="" type="checkbox"> <a href="/en/design-pattern/singleton-pattern">1.1.Singleton Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">1.2.Factory Method Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">1.3.Abstract Factory Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">1.4.Builder Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">1.5.Prototype Pattern</a></li></ul><p><strong>2. Strctural Pattern:</strong></p><ul><li><input disabled="" type="checkbox"> <a href="#">2.1.Adapter Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.2.Decorator Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.3.Proxy Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.4.Facade Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.5.Bridge Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.6.Composite Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">2.7.Flyweight Pattern</a></li></ul><p><strong>3. Behavioral Pattern:</strong></p><ul><li><input disabled="" type="checkbox"> <a href="#">3.1.Strategy Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.2.Template Method Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.3.Observer Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.4.Iterator Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.5.Chain of Responsibility Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.6.Command Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.7.Memento Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.8.State Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.9.Visitor Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.10.Mediator Pattern</a></li><li><input disabled="" type="checkbox"> <a href="#">3.11.Interpreter Pattern</a></li></ul>]]></content>
        
        
        <categories>
            
            <category> 23 Design Patterns </category>
            
            <category> 0. Overview </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Design_Pattern </tag>
            
            <tag> Overview </tag>
            
        </tags>
        
    </entry>
    
    
    
    
</search>